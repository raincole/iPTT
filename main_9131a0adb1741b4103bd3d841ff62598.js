function receivedFromPTT(t){var e="",r=!0;byteBuffer=byteBuffer.concat(t);for(var i=0;i<byteBuffer.length;i++)if(byteBuffer[i]<128)e+=String.fromCharCode(byteBuffer[i]);else if(i===byteBuffer.length-1)r=!1;else{r=!1;for(var n=!1,s=i+1;s<byteBuffer.length;s++){var a=256*byteBuffer[i]+byteBuffer[s];a>=65520&&(a=41404);var o=Big5ToUnicode[a];if(o&&n===!1){e+=String.fromCharCode(o),i=s,r=!0;break}27===byteBuffer[s]&&(n=!0),n===!0&&(e+=String.fromCharCode(byteBuffer[s])),109===byteBuffer[s]&&(n=!1)}}r===!0&&(byteBuffer=[],Logger.info("\n==================================================\n"),Logger.info(e),term.write(e),null!==handler&&handler.onData(term))}function writeMessage(t){Logger.info("Write to PTT: "+t);for(var e=[],r=0;r<t.length;r++){var i=t.charCodeAt(r);if(128>i)e.push(i);else{var n=UnicodeToBig5[i],s=n/256,a=n%256;e.push(s,a)}}this.writeByteArray(e)}function registerNextHandler(t){nextHandler=t;var e=t.getTimeout?t.getTimeout():3e4;client.setTimeout(e,t)}IS_ON_IOS=!0,require=function(){return{}},module={},String.prototype.removeSpace=function(){return this.replace(/\s/g,"")},String.prototype.removeTailingSpace=function(){return this.replace(/\s+$/g,"")},String.prototype.removeHeadingSpace=function(){return this.replace(/\s([^\s])/g,function(t,e){return e})},String.prototype.stripSpace=function(){return this.replace(/(^\s+)|(\s+$)/g,"")},String.prototype.fixFullWidthCharacters=function(){return this.replace(/ ([\u0080-\uffff])/g,"$1")},function(){if(IS_ON_IOS)Logger={info:function(){_log("INFO ("+Array.prototype.join.call(arguments," ")+")")},debug:function(){_log("DEBUG ("+Array.prototype.join.call(arguments," ")+")")},error:function(){_log("ERR ("+Array.prototype.join.call(arguments," ")+")")}};else{var t=require("winston"),e=require("fs");e.truncate("./log/debug.log",0),e.truncate("./log/raw.log",0),e.truncate("./log/data.log",0),Logger=new t.Logger({transports:[new t.transports.Console({json:!1,timestamp:!0}),new t.transports.File({filename:__dirname+"/log/debug.log",json:!1})],exitOnError:!1})}module.exports=Logger}(),function(){var t={INPUTTED:"inputted",LOGGED_IN:"logged_in"};LoginHandler=function(t,e,r,i){this.client=t,this.callback=i,this.username=e,this.password=r,this.checkedKicking=!1,this.checkedAttempts=!1,this.enterCounter=10},LoginHandler.prototype.start=function(){this.inputInfo(this.username,this.password),this.status=t.INPUTTED},LoginHandler.prototype.changeStatus=function(t){Logger.info("LoginHandler: "+this.status+" -> "+t),this.status=t},LoginHandler.prototype.inputInfo=function(t,e){this.client.write(t+"\r\n"+e+"\r\n")},LoginHandler.prototype.getTimeout=function(){return 15e3},LoginHandler.prototype.isEnded=function(){return this.status===t.LOGGED_IN},LoginHandler.prototype.end=function(){this.status=t.LOGGED_IN},LoginHandler.prototype.onData=function(e){switch(Logger.info("LoginHandler",this.status),this.status){case t.INPUTTED:-1!==e.getText(21,0,80).removeSpace().indexOf("密碼不對或無此帳號")?(this.changeStatus(t.LOGGED_IN),this.callback({message:"wrong_username_or_password"})):-1!==e.getText(22,0,80).removeSpace().indexOf("您想刪除其他重複登入的連線嗎")&&this.checkedKicking===!1?(this.client.write("n\r\n"),this.checkedKicking=!0):-1!==e.getText(23,0,80).removeSpace().indexOf("您要刪除以上錯誤嘗試的記錄嗎")&&this.checkedAttempts===!1?(this.client.write("n\r\n"),this.checkedAttempts=!0):-1!==e.getText(23,0,80).removeSpace().indexOf("按任意鍵繼續")?this.client.write("x"):-1!==e.getText(0,0,80).removeSpace().indexOf("本日十大熱門話題")?this.client.write("q"):-1!==e.getAllTexts().join("").indexOf("(G)oodbye")&&(this.changeStatus(t.LOGGED_IN),this.callback(null))}},module.exports=LoginHandler}(),function(){var t={BEGINNING:"beginning",ENDING:"ending"};LogoutHandler=function(t,e){this.client=t,this.callback=e},LogoutHandler.prototype.start=function(){this.client.write("g\r\ny\r\n"),this.status=t.BEGINNING},LogoutHandler.prototype.changeStatus=function(t){Logger.info("LogoutHandler: "+this.status+" -> "+t),this.status=t},LogoutHandler.prototype.isEnded=function(){return this.status===t.ENDING},LogoutHandler.prototype.end=function(){this.status=t.ENDING},LogoutHandler.prototype.onData=function(e){Logger.info("LogoutHandler",this.status),this.status===t.BEGINNING&&-1!==e.getText(23,0,80).indexOf("此 次 停 留 時 間")&&(this.callback(null),this.changeStatus(t.ENDING),this.client.write("\r\n"))},module.exports=LogoutHandler}(),function(){function t(t,e,r){var i=t.substr(0,7).match(/\d+$/);if(null!==i)var n=parseInt(i[0]);else var n=0/0;var s=t.substr(10,13).removeSpace(),a=t.substr(30,33).removeHeadingSpace().fixFullWidthCharacters(),o=t.substr(67,12),l=t.substr(24,3).removeSpace(),c="ˇ"===t[9],u=t.substr(64,3).removeSpace(),h="",d=0;if("HOT"===u)h="hot";else if("爆!"===u)switch(e){case 1:h="red";break;case 2:h="green";break;case 3:h="yellow";break;case 4:h="blue";break;case 5:h="purple";break;case 6:h="cyan";break;case 7:h="white"}else h="count",d=""===u?0:parseInt(u);var g=6===r;return isNaN(n)||0>=n||""===s||isNaN(d)||0>d||d>=100?null:{number:n,name:s,title:a,boardMasters:o,tag:l,viewerSign:h,viewerCount:d,hasUnread:c,favorited:g}}var e={BEGINNING:"beginning",HOT_LIST:"hot_list",WAIT_MORE:"wait_more",GOT_PAGE:"got_page",ENDING:"ending"};HotHandler=function(t,e){this.client=t,this.callback=e,this.boardList={type:"hot",items:[]},this.gotNumbers=[]},HotHandler.prototype.start=function(){this.enterHotList(),this.status=e.BEGINNING},HotHandler.prototype.enterHotList=function(){this.client.write("t1\r\n")},HotHandler.prototype.enterNewPage=function(){this.client.write(""),this.changeStatus(e.HOT_LIST)},HotHandler.prototype.changeStatus=function(t){Logger.info("HotHandler: "+this.status+" -> "+t),this.status=t},HotHandler.prototype.parseList=function(e,r){for(var i=this.boardList.items.length%20+3,n=[],s=i;23>s;s++)if(""!==e[s].removeSpace()){var a=t(e[s],r.getColor(s,65).frontground,r.getColor(s,10).frontground);n.push(a),null===a&&Logger.info(e[s])}return n},HotHandler.prototype.checkItems=function(t){this.boardList.items;for(var e=0,r=0;r<t.length;r++){var i=t[r];null===i||this.gotNumbers[i.number]||e++}return e},HotHandler.prototype.addItems=function(t){for(var e=this.boardList.items,r=0;r<t.length;r++){var i=t[r];null===i||this.gotNumbers[i.number]||(e.push(i),this.gotNumbers[i.number]=!0)}},HotHandler.prototype.isEnded=function(){return this.status===e.ENDING},HotHandler.prototype.end=function(){this.status=e.ENDING},HotHandler.prototype.onData=function(t){if(Logger.info("HotHandler",this.status),this.status!==e.ENDING&&(this.status===e.BEGINNING&&"看 板 列"==t.getText(0,3,8)&&this.changeStatus(e.HOT_LIST),this.status===e.HOT_LIST||this.status===e.WAIT_MORE)){for(var r=this.parseList(t.getAllTexts(),t),i=0;i<r.length;i++)if(null===r[i])return;var n=this.checkItems(r);0===n?(this.callback(null,this.boardList),this.changeStatus(e.ENDING)):n===r.length&&(this.addItems(r),this.enterNewPage())}},module.exports=HotHandler}(),function(){function t(t){var e=t.substring(33,80).fixFullWidthCharacters(),r=/^.*\[(.*)\]/,i=r.exec(e),n=i?i[1]:"",s=e.replace(r,"").stripSpace(),a=t.substring(17,30).removeSpace(),o=t.substring(2,7).removeSpace(),l=0,c=!1;"★"===o?c=!0:l=parseInt(o);var u=t.substring(9,11).removeSpace(),h=0;h="爆"===u?100:"X"===u[0]?"X"===u[1]?-100:-10*parseInt(u[1]):""===u?0:parseInt(u);var d="normal";":"===t[31]?d="reply":"轉"===t[31]?d="xpost":"-"===a&&(d="deleted");var g=t.substring(11,16).removeSpace(),f="other";switch(t[8]){case"+":f="unread";break;case"~":f="unreadComment";break;case" ":f="normal";break;case"!":f="locked"}return!c&&(0>=l||isNaN(l))||""===a||""===s?null:{title:s,tag:n,author:a,score:h,number:l,type:d,pinned:c,date_without_year:g,status:f}}function e(t){for(var e=0,r=t.length-1;r>=0&&t[r].pinned!==!1;r--)t[r].number=e,e--}function r(t,e){function r(t){if(e.score){var r=e.score;if(r>=0){if(t.score<r)return!1}else if(r-t.score<-10)return!1}if(e.title){var i=e.title.toLowerCase(),n=("["+t.tag+"] "+t.title).toLowerCase();if(-1===n.indexOf(i))return!1}if(e.author){var s=e.author.toLowerCase();if(-1===t.author.toLowerCase().indexOf(s))return!1}return!0}for(var i=0;i<t.length;i++)if(r(t[i])===!1)return!1;return!0}var i={BEGINNING:"beginning",GETTING_INFO:"getting_info",SEARCHING:"searching",JUMPING:"jumping",GETTING_ARTICLES:"getting_articles",ENDING:"ending"};BoardHandler=function(t,e,r,i,n){4===arguments.length&&(n=i,i=r,r={}),this.client=t,this.name=e,this.criteria=r,this.pivot=i,this.callback=n,this.board={name:e,articles:[]}},BoardHandler.prototype.start=function(){this.enterBoard(this.name),this.status=i.BEGINNING},BoardHandler.prototype.enterBoard=function(t){this.client.write("qs"+t+"\r\n")},BoardHandler.prototype.changeStatus=function(t){Logger.info("BoardHandler: "+this.status+" -> "+t),this.status=t},BoardHandler.prototype.parseAndMergeInfo=function(t){this.board.title=t[6].substr(21).fixFullWidthCharacters().removeTailingSpace(),this.board.boardMasters=t[7].substr(15).fixFullWidthCharacters().removeTailingSpace(),this.board.dislikable="開 放"===t[15].substr(6,3)},BoardHandler.prototype.parseArticles=function(e){var r=e.slice(3,23).map(function(e){return t(e)}).filter(function(t){return null!==t});return r},BoardHandler.parseArticle=t,BoardHandler.prototype.isInBoard=function(){return this.status===i.GETTING_ARTICLES||this.status===i.ENDING},BoardHandler.prototype.isEnded=function(){return this.status===i.ENDING},BoardHandler.prototype.end=function(){this.status=i.ENDING},BoardHandler.prototype.onData=function(t){if(Logger.info("BoardHandler",this.status),this.status!==i.ENDING&&(this.status===i.BEGINNING&&("  文 章 選 讀  (y) 回 應(X) 推 文(^X) 轉 錄 (=[]<>) 相 關 主 題(/?a) 找 標 題/ 作 者 (b) 進 板 畫 面   "===t.getText(23,0,80)?(this.changeStatus(i.GETTING_INFO),this.client.write("i")):this.client.write("x")),this.status===i.GETTING_INFO&&t.getText(4,0,40).removeSpace().toLowerCase()==="《"+this.board.name.toLowerCase()+"》看板設定"&&"請 按 任 意 鍵 繼 續"===t.getText(23,33,46)&&(this.parseAndMergeInfo(t.getAllTexts()),this.changeStatus(i.SEARCHING),this.client.write("x")),this.status===i.SEARCHING&&"  文 章 選 讀  (y) 回 應(X) 推 文(^X) 轉 錄 (=[]<>) 相 關 主 題(/?a) 找 標 題/ 作 者 (b) 進 板 畫 面   "===t.getText(23,0,80)&&(this.criteria.title&&this.client.write("/"+this.criteria.title+"\r\n"),this.criteria.score&&this.client.write("Z"+this.criteria.score+"\r\n"),this.criteria.author&&this.client.write("a"+this.criteria.author+"\r\n"),this.changeStatus(i.JUMPING)),this.status===i.JUMPING&&"[ ←] 離 開 [ →] 閱 讀 [Ctrl-P] 發 表 文 章 [d] 刪 除 [z] 精 華 區 [i] 看 板 資 訊/ 設 定 [h] 說 明   "===t.getText(1,0,80)&&(null!==this.pivot?this.client.write(this.pivot+"\r\n"):this.client.write("1\r\nk"),this.changeStatus(i.GETTING_ARTICLES)),Logger.info("\n@@@\n"+t.getAllTexts()+"\n@@@\n"),this.status===i.GETTING_ARTICLES&&"[ ←] 離 開 [ →] 閱 讀 [Ctrl-P] 發 表 文 章 [d] 刪 除 [z] 精 華 區 [i] 看 板 資 訊/ 設 定 [h] 說 明   "===t.getText(1,0,80))){var n=!1;if(null===this.pivot)n=!0;else for(var s=0;s<t.rows;s++){var a=t.getText(s,0,80);a.substring(2,7).removeSpace()===this.pivot+""&&(n=!0)}if(n===!0){var o=this.parseArticles(t.getAllTexts()),l=r(o,this.criteria);l&&(this.board.articles=this.board.articles.concat(o),e(this.board.articles),this.callback(null,this.board),this.changeStatus(i.ENDING))}}},module.exports=BoardHandler}(),function(){function t(t){var e=/\d+%/.exec(t),r=0/0;null!==e&&(r=parseInt(e[0]));var i=/(\d{2,5})~(\d{2,5})/.exec(t),n=0/0,s=0/0;return null!==i&&(n=parseInt(i[1])-1,s=parseInt(i[2])),isNaN(r)||isNaN(n)||isNaN(s)?null:{progress:r,startLine:n,endLine:s}}function e(t){var e=t[0].fixFullWidthCharacters(),r=t[1].fixFullWidthCharacters(),i=t[2].fixFullWidthCharacters(),n=/作者  (.*) \(/.exec(e),s=n?n[1]:"",a=/作者  .* \((.*)\)/.exec(e),o=a?a[1]:"",l=/標題  (Re: |Fw: )?\[(.*)\]/.exec(r),c=l?l[2]:"",u=/標題  (Re: |Fw: )?(\[.*\])? (.*)/.exec(r),h=u?u[3].removeTailingSpace():"",d=/時間  (.*)/.exec(i),g="";if(null!==d){var f=new Date(d[1]),p=new Date(f.getTime()+288e5);g=p.toISOString()}return{author:s,authorNickname:o,tag:c,title:h,date:g}}function r(t){return t?t.substring(0,78).match(/ *$/)[0]:null}function i(t){if(0===t.length)return"";for(var e="",i=0;i<t.length;i++){var n=!0,s=t[i+1];if(void 0!==s&&0!==s.removeSpace().length){var a=r(t[i-1]),o=r(t[i]),l=r(s),c=t[i].match(/^ */)[0];a&&a.length+c.length<2&&(n=!1),a&&Math.abs(a.length-o.length)<=1&&(n=!1),l&&Math.abs(l.length-o.length)<=1&&(n=!1);var u=/(,|[^.]\.|!|\?|:|;|\(|\)|，|。|！|？|：|；|『|』|「|」|（|）|—)\s*$/,h=t[i].substring(0,78).match(u);null!==h&&c.length<2&&(e=e.replace(u,"$1"),n=!1)}e+=t[i].stripSpace(),n===!0&&(e+="\n")}return e}function n(t){for(var e=[],r=t,n={type:"normal",texts:[]},s=0;s<r.length;s++){if(":"===r[s][0]||"※"===r[s][0])var a="quote",o=r[s].substr(1);else var a="normal",o=r[s];n.type!==a?(e.push({type:n.type,text:i(n.texts)}),n={type:a,texts:[o]}):n.texts.push(o)}return e.push({type:n.type,text:i(n.texts)}),e=e.filter(function(t){return""!==t.text})}function s(e){for(var r=e.map(function(t){return t.fixFullWidthCharacters()}),s=[],a=r.indexOf("───────────────────────────────────────  "),o=a+1;o<r.length;o++)if(void 0!==r[o]&&-1===r[o].indexOf("瀏覽 第")){if(null!==r[o].match(/^※ 發信站:/)){o+=2;break}s.push(e[o])}for(var l=[],c=[];o<r.length&&null===t(r[o]);o++)if("※"!==r[0]){var u=/^(推|噓|→)\s*(.*?):(.*)\d\d\/\d\d \d\d:\d\d  $/.exec(r[o]);if(null!==u){c.length>0&&(l.push({type:"authorComment",author:"",content:i(c).removeTailingSpace()}),c=[]);var h="neutral";"推"===u[1]&&(h="like"),"噓"===u[1]&&(h="dislike"),l.push({type:h,author:u[2],content:u[3].removeTailingSpace()})}else c.push(r[o])}return c.length>0&&l.push({type:"authorComment",author:"",content:i(c)}),{content:n(s.map(function(t){return t.fixFullWidthCharacters()})),comments:l}}var a={BEGINNING:"beginning",SELECTING_ITEM:"selecting_item",GETTING_URL:"getting_url",GETTING_ARTICLE:"getting_article",GETTING_MORE:"getting_more",ENDING:"ending"};ArticleHandler=function(t,e,r,i,n,s){5===arguments.length&&(s=n,n=i,i=r,r={}),this.client=t,this.callback=n,this.progressCallback=s,this.prevProgress=0,this.boardName=e,this.criteria=r,this.articleNum=i,this.article={comments:[]},this.cachedTexts=[]},ArticleHandler.prototype.start=function(){this.boardHandler=new BoardHandler(this.client,this.boardName,this.criteria,null,function(){}),this.boardHandler.start(),this.status=a.BEGINNING},ArticleHandler.prototype.changeStatus=function(t){Logger.info("ArticleHandler: "+this.status+" -> "+t),this.status=t},ArticleHandler.prototype.nextPage=function(){this.status!==a.ENDING&&this.client.write("jjjjj")},ArticleHandler.prototype.checkMissing=function(){"找 不 到 這 個 文 章 代 碼"===term.getText(22,1,18)&&this.callback({message:"missing_article"},null)},ArticleHandler.prototype.isSelected=function(){return this.status===a.SELECTING_ITEM},ArticleHandler.prototype.isInArticle=function(){return this.status==a.GETTING_ARTICLE},ArticleHandler.prototype.isEnded=function(){return this.status===a.ENDING},ArticleHandler.prototype.end=function(){this.status=a.ENDING},ArticleHandler.prototype.onData=function(r){if(Logger.info("ArticleHandler",this.status),this.status!==a.ENDING)if(this.status===a.BEGINNING&&(this.boardHandler.onData(r),this.boardHandler.isInBoard()))if(this.changeStatus(a.SELECTING_ITEM),"string"==typeof this.articleNum)this.client.write(this.articleNum+"\r\n");else if(this.articleNum>0)this.client.write(this.articleNum+"\r\n");else{for(var i="k",n=0;n<-this.articleNum;n++)i+="k";this.client.write("1\r\n"+i)}else{if(this.status===a.SELECTING_ITEM&&(this.checkMissing(),this.changeStatus(a.GETTING_URL),this.client.write("Q")),this.status===a.GETTING_URL){this.checkMissing();var o=r.getAllTexts(),l=o.indexOf(" ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐  ");if(-1!==l){var c=o[l+2].fixFullWidthCharacters(),u=c.match(/http:\/\/.*\.html/);this.article.url=null===u?"":u[0];var c=o[l+1],h=c.match(/#[a-zA-Z0-9]{8}/);this.article.id=null===h?"":h[0],this.changeStatus(a.GETTING_ARTICLE),this.client.write("xxx[C")}}if(this.status===a.GETTING_ARTICLE||this.status===a.GETTING_MORE){var d=t(r.getText(23,0,80));if(null!==d&&d.endLine>=this.cachedTexts.length){this.progressCallback(d.progress),d.progress>this.prevProgress&&(this.prevProgress=d.progress,this.client.setTimeout(1e3,this));for(var n=d.startLine;n<=d.endLine;n++)this.cachedTexts[n]=r.getText(n-d.startLine,0,80);if(100===d.progress){var g=e(this.cachedTexts),f=s(this.cachedTexts);this.article.title=g.title,this.article.tag=g.tag,this.article.author=g.author,this.article.authorNickname=g.authorNickname,this.article.date=g.date,this.article.content=f.content,this.article.comments=f.comments,this.callback(null,this.article),this.changeStatus(a.ENDING)}else this.nextPage()}}}},module.exports=ArticleHandler}(),function(){var t={BEGINNING:"beginning",ITERATING:"iterating",ENDING:"ending"};RelatedArticleHandler=function(t,e,r,i){this.client=t,this.callback=i,this.boardName=e,this.articleNum=r,this.articleDict={}},RelatedArticleHandler.prototype.start=function(){this.articleHandler=new ArticleHandler(this.client,this.boardName,this.articleNum,function(){},function(){}),this.articleHandler.start(),this.status=t.BEGINNING},RelatedArticleHandler.prototype.changeStatus=function(t){Logger.info("RelatedArticleHandler: "+this.status+" -> "+t),this.status=t},RelatedArticleHandler.prototype.isEnded=function(){return this.status===t.ENDING},RelatedArticleHandler.prototype.end=function(){this.status=t.ENDING},RelatedArticleHandler.prototype.onData=function(e){if(Logger.info("RelatedArticleHandler",this.status),this.status!==t.ENDING&&(this.status===t.BEGINNING&&(this.articleHandler.isInArticle()?(this.changeStatus(t.ITERATING),this.client.write("=q")):this.articleHandler.onData(e)),this.status===t.ITERATING&&"  文 章 選 讀  (y) 回 應(X) 推 文(^X) 轉 錄 (=[]<>) 相 關 主 題(/?a) 找 標 題/ 作 者 (b) 進 板 畫 面   "===e.getText(23,0,80))){var r=0,i=e.getAllTexts();for(r=0;r<i.length&&"●"!==i[r][1];r++);var n=BoardHandler.parseArticle(i[r]);this.articleDict[n.number]=n,this.client.write("+");var s=Object.keys(this.articleDict).length,a=this.articleDict,o=this;setTimeout(function(){var e=Object.keys(a);e.length===s&&(o.changeStatus(t.ENDING),o.callback(null,e.map(function(t){return a[t]})))},1e3)}},module.exports=RelatedArticleHandler}(),function(){function t(t,e){var r=t.substr(0,7).match(/\d+$/);if(null!==r)var i=parseInt(r[0]);else var i=0/0;var n=t.substr(10,14).removeSpace(),s=t.substr(30,33).removeHeadingSpace().fixFullWidthCharacters(),a=t.substr(67,12),o=t.substr(24,3).removeSpace(),l="ˇ"===t[9],c=t.substr(64,3).removeSpace(),u="",h=0;if("HOT"===c)u="hot";else if("爆!"===c)switch(e){case 1:u="red";break;case 2:u="green";break;case 3:u="yellow";break;case 4:u="blue";break;case 5:u="purple";break;case 6:u="cyan";break;case 7:u="white"}else u="count",h=""===c?0:parseInt(c);return isNaN(i)||0>=i?null:"MyFavFolder"===n?{type:"directory",number:i,name:s}:"------------"===n?{type:"separator",number:i}:""===n||isNaN(h)||0>h||h>=100?null:{type:"boardItem",number:i,boardItem:{name:n,title:s,boardMasters:a,tag:o,viewerSign:u,viewerCount:h,hasUnread:l,favorited:!0}}}var e={BEGINNING:"beginning",FOLLOWING_PATH:"following_path",FAVORITES_LIST:"favorites_list",WAIT_MORE:"wait_more",GOT_PAGE:"got_page",ENDING:"ending"};FavoritesHandler=function(t,e,r){this.client=t,this.path=e,this.callback=r,this.boardList={type:"favorites",items:[]},this.gotNumbers=[]},FavoritesHandler.prototype.start=function(){this.enterList(),this.status=e.BEGINNING},FavoritesHandler.prototype.enterList=function(){this.client.write("f1\r\n")},FavoritesHandler.prototype.enterNewPage=function(){this.client.write(""),this.changeStatus(e.FAVORITES_LIST)},FavoritesHandler.prototype.changeStatus=function(t){Logger.info("FavoritesHandler: "+this.status+" -> "+t),this.status=t},FavoritesHandler.prototype.parseList=function(e,r){for(var i=this.boardList.items.length%20+3,n=[],s=i;23>s;s++)if(""!==e[s].removeSpace()&&" ●        ---  空 目 錄 ， 請 按 a  新 增 或 用 y  列 出 全 部 看 板 後 按 z  增 刪 ---             "!==e[s]){var a=t(e[s],r.getColor(s,65).frontground,r.getColor(s,10).frontground);null===a&&Logger.info(e[s]),n.push(a)}return n},FavoritesHandler.prototype.checkItems=function(t){this.boardList.items;for(var e=0,r=0;r<t.length;r++){var i=t[r];null===i||this.gotNumbers[i.number]||e++}return e},FavoritesHandler.prototype.addItems=function(t){for(var e=this.boardList.items,r=0;r<t.length;r++){var i=t[r];null===i||this.gotNumbers[i.number]||(e.push(i),this.gotNumbers[i.number]=!0)}},FavoritesHandler.prototype.isEnded=function(){return this.status===e.ENDING},FavoritesHandler.prototype.end=function(){this.status=e.ENDING},FavoritesHandler.prototype.isInList=function(){return this.status===e.FAVORITES_LIST},FavoritesHandler.prototype.onData=function(t){if(Logger.info("FavoritesHandler",this.status),this.status!==e.ENDING){if(Logger.info(t.getText(0,0,80)),this.status===e.BEGINNING&&"看 板 列"==t.getText(0,3,8)&&this.changeStatus(e.FOLLOWING_PATH),this.status===e.FOLLOWING_PATH)if(0===this.path.length)this.changeStatus(e.FAVORITES_LIST);else{var r=this.path.shift();this.client.write(r+"\r\n\r\n$")}if(this.status===e.FAVORITES_LIST||this.status===e.WAIT_MORE){for(var i=this.parseList(t.getAllTexts(),t),n=0;n<i.length;n++)if(null===i[n])return;var s=this.checkItems(i);0===s?(this.callback(null,this.boardList),this.changeStatus(e.ENDING)):s===i.length&&(this.addItems(i),20===s?this.enterNewPage():(this.callback(null,this.boardList),this.changeStatus(e.ENDING)))}}},module.exports=FavoritesHandler}(),function(){var t={BEGINNING:"beginning",ADDING_BOARD:"adding_board",ENDING:"ending"};FavoritesAddHandler=function(t,e,r,i){this.client=t,this.path=e,this.boardName=r,this.callback=i},FavoritesAddHandler.prototype.start=function(){this.favoritesHandler=new FavoritesHandler(this.client,this.path,this.callback),this.favoritesHandler.start(),this.status=t.BEGINNING},FavoritesAddHandler.prototype.changeStatus=function(t){Logger.info("FavoritesHandler: "+this.status+" -> "+t),this.status=t},FavoritesAddHandler.prototype.isEnded=function(){return this.status===t.ENDING},FavoritesAddHandler.prototype.end=function(){this.status=t.ENDING},FavoritesAddHandler.prototype.onData=function(e){Logger.info("FavoritesAddHandler",this.status),this.status!==t.ENDING&&(this.status===t.BEGINNING&&(this.favoritesHandler.onData(e),(this.favoritesHandler.isInList()||this.favoritesHandler.isEnded())&&this.changeStatus(t.ADDING_BOARD)),this.status===t.ADDING_BOARD&&(this.client.write("a"+this.boardName+"\r\n"),this.callback(null),this.changeStatus(t.ENDING)))},module.exports=FavoritesAddHandler}(),function(){var t={BEGINNING:"beginning",REMOVING_BOARD:"removing_board",ENDING:"ending"};FavoritesRemoveHandler=function(t,e,r,i){this.client=t,this.path=e,this.number=r,this.callback=i},FavoritesRemoveHandler.prototype.start=function(){this.favoritesHandler=new FavoritesHandler(this.client,this.path,this.callback),this.favoritesHandler.start(),this.status=t.BEGINNING},FavoritesRemoveHandler.prototype.changeStatus=function(t){Logger.info("FavoritesHandler: "+this.status+" -> "+t),this.status=t},FavoritesRemoveHandler.prototype.isEnded=function(){return this.status===t.ENDING},FavoritesRemoveHandler.prototype.end=function(){this.status=t.ENDING},FavoritesRemoveHandler.prototype.onData=function(e){Logger.info("FavoritesRemoveHandler",this.status),this.status!==t.ENDING&&(this.status===t.BEGINNING&&(this.favoritesHandler.isInList()?this.changeStatus(t.REMOVING_BOARD):this.favoritesHandler.onData(e)),this.status===t.REMOVING_BOARD&&(this.client.write(this.number+"\r\ndy\r\n"),this.callback(null),this.changeStatus(t.ENDING)))},module.exports=FavoritesRemoveHandler}(),function(){var t={BEGINNING:"beginning",MOVING_BOARD:"moving_board",ENDING:"ending"};FavoritesMoveHandler=function(t,e,r,i,n){this.client=t,this.path=e,this.from=r,this.to=i,this.callback=n},FavoritesMoveHandler.prototype.start=function(){this.favoritesHandler=new FavoritesHandler(this.client,this.path,this.callback),this.favoritesHandler.start(),this.status=t.BEGINNING},FavoritesMoveHandler.prototype.changeStatus=function(t){Logger.info("FavoritesHandler: "+this.status+" -> "+t),this.status=t},FavoritesMoveHandler.prototype.isEnded=function(){return this.status===t.ENDING},FavoritesMoveHandler.prototype.end=function(){this.status=t.ENDING},FavoritesMoveHandler.prototype.onData=function(e){Logger.info("FavoritesMoveHandler",this.status),this.status!==t.ENDING&&(this.status===t.BEGINNING&&(this.favoritesHandler.isInList()?this.changeStatus(t.MOVING_BOARD):this.favoritesHandler.onData(e)),this.status===t.MOVING_BOARD&&(this.client.write(this.from+"\r\nM"+this.to+"\r\n"),this.callback(null),this.changeStatus(t.ENDING)))},module.exports=FavoritesMoveHandler}(),function(){var t={BEGINNING:"beginning",POSTING:"posting",ENDING:"ending"};CommentHandler=function(t,e,r,i,n,s){switch(this.client=t,this.callback=s,this.content=n,this.type=i,i){case"like":this.typeNum=1;break;case"dislike":this.typeNum=2;break;case"neutral":this.typeNum=3}this.boardName=e,this.articleNum=r},CommentHandler.prototype.start=function(){this.articleHandler=new ArticleHandler(this.client,this.boardName,this.articleNum,function(){},function(){}),this.articleHandler.start(),this.status=t.BEGINNING},CommentHandler.prototype.changeStatus=function(t){Logger.info("CommentHandler: "+this.status+" -> "+t),this.status=t},CommentHandler.prototype.isEnded=function(){return this.status===t.ENDING},CommentHandler.prototype.end=function(){this.status=t.ENDING},CommentHandler.prototype.onData=function(e){if(Logger.info("CommentHandler",this.status),this.status!==t.ENDING&&(this.status===t.BEGINNING&&(this.articleHandler.isSelected()?(this.changeStatus(t.POSTING),this.client.write("%")):this.articleHandler.onData(e)),this.status===t.POSTING))if("作 者 本 人"===e.getText(22,1,8)||"時 間 太 近"===e.getText(22,1,8))this.client.write(this.content+"\r\ny\r\n"),this.callback(null),this.changeStatus(t.ENDING);else if("您 覺 得 這 篇 文 章"===e.getText(23,1,14))this.client.write(this.typeNum+""),this.client.write(this.content+"\r\ny\r\n"),this.callback(null),this.changeStatus(t.ENDING);else if(e.getText(23,0,80).indexOf("本 板 禁 止 快 速 連 續 推 文")){var r=e.getText(23,0,80).removeSpace(),i=/請再等\s*(\d+)\s*秒/,n=r.match(i);if(null!==n){var s=parseInt(n[1]);this.callback({message:"comment_delayed",delay:s}),this.changeStatus(t.ENDING)}}},module.exports=CommentHandler}(),"undefined"==typeof IS_ON_IOS&&(IS_ON_IOS=!1),require("./uao"),require("./board_list"),require("./utils"),require("./logger"),require("./handlers/LoginHandler"),require("./handlers/LogoutHandler"),require("./handlers/HotHandler"),require("./handlers/FavoritesHandler"),require("./handlers/FavoritesAddHandler"),require("./handlers/FavoritesMoveHandler"),require("./handlers/FavoritesRemoveHandler"),require("./handlers/BoardHandler"),require("./handlers/ArticleHandler"),require("./handlers/RelatedArticleHandler"),require("./handlers/CommentHandler"),require("./handlers/BoardNameFetcher"),require("./term.js"),term=new Terminal({cols:80,rows:24,screenKeys:!0});var handler=null,client,byteBuffer=[];if(IS_ON_IOS)client={write:writeMessage};else{var net=require("net"),Iconv=require("iconv").Iconv,iconv=new Iconv("BIG5","UTF-8//TRANSLIT//IGNORE");client=net.connect(23,"ptt.cc",function(){Logger.info("Client Connected")});var oldWrite=client.write;client.write=writeMessage,client.writeByteArray=function(t){oldWrite.call(client,new Buffer(t))},client.on("data",function(t){receivedFromPTT(Array.prototype.slice.call(t,0))}),client.on("end",function(){Logger.info("Client Disconnected")})}var nextHandler=null,PTT={registerSendToPTTCallback:function(t){client.writeByteArray=t},receivedFromPTT:receivedFromPTT,login:function(t,e,r){registerNextHandler(new LoginHandler(client,t,e,r))},logout:function(t){registerNextHandler(new LogoutHandler(client,t))},getHot:function(t){registerNextHandler(new HotHandler(client,t))},getBoard:function(t,e,r){registerNextHandler(new BoardHandler(client,t,e,r))},searchBoard:function(t,e,r,i){registerNextHandler(new BoardHandler(client,t,e,r,i))},getArticle:function(t,e,r,i){registerNextHandler(new ArticleHandler(client,t,e,r,i))},getSearchedArticle:function(t,e,r,i,n){registerNextHandler(new ArticleHandler(client,t,e,r,i,n))},getRelatedArticles:function(t,e,r){registerNextHandler(new RelatedArticleHandler(client,t,e,r))},postComment:function(t,e,r,i,n){registerNextHandler(new CommentHandler(client,t,e,r,i,n))},getFavorites:function(t,e){registerNextHandler(new FavoritesHandler(client,t,e))},addFavorite:function(t,e,r){registerNextHandler(new FavoritesAddHandler(client,t,e,r))},removeFavorite:function(t,e,r){registerNextHandler(new FavoritesRemoveHandler(client,t,e,r))},moveFavorite:function(t,e,r,i){registerNextHandler(new FavoritesMoveHandler(client,t,e,r,i))},fetchBoardNames:function(t){registerNextHandler(new BoardNameFetcher(client,t))}};client.setTimeout=function(t,e){client.timeoutStamp=Math.random();var r=client.timeoutStamp;setTimeout(function(){client.timeoutStamp===r&&(e.isEnded()||(client.write("\r\n"),e.callback({message:"timeout"}),e.end()))},t)};var mainIter=function(){null!==nextHandler&&(-1!==term.getAllTexts().join("").indexOf("(G)oodbye")||nextHandler instanceof LoginHandler?(null===handler||handler.isEnded()||(handler.callback({message:"interrupted"}),handler.end()),handler=nextHandler,nextHandler=null,handler.start()):client.write("q")),setTimeout(mainIter,10)};mainIter(),module.exports=PTT;
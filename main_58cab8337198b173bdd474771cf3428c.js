function receivedFromPTT(t){var e="",s=!0;byteBuffer=byteBuffer.concat(t);for(var i=0;i<byteBuffer.length;i++)if(byteBuffer[i]<128)e+=String.fromCharCode(byteBuffer[i]);else if(i===byteBuffer.length-1)s=!1;else{s=!1;for(var r=!1,a=i+1;a<byteBuffer.length;a++){var n=256*byteBuffer[i]+byteBuffer[a];n>=65520&&(n=41404);var o=Big5ToUnicode[n];if(o&&r===!1){e+=String.fromCharCode(o),i=a,s=!0;break}27===byteBuffer[a]&&(r=!0),r===!0&&(e+=String.fromCharCode(byteBuffer[a])),109===byteBuffer[a]&&(r=!1)}}s===!0&&(byteBuffer=[],Logger.info("\n==================================================\n"),Logger.info(e),term.write(e),null!==handler&&handler.onData(term))}function writeMessage(t){Logger.info("Write to PTT: "+t);for(var e=[],s=0;s<t.length;s++){var i=t.charCodeAt(s);if(128>i)e.push(i);else{var r=UnicodeToBig5[i],a=r/256,n=r%256;e.push(a,n)}}this.writeByteArray(e)}IS_ON_IOS=!0,require=function(){return{}},module={},String.prototype.removeSpace=function(){return this.replace(/\s/g,"")},String.prototype.removeTailingSpace=function(){return this.replace(/\s+$/g,"")},String.prototype.removeHeadingSpace=function(){return this.replace(/\s([^\s])/g,function(t,e){return e})},String.prototype.stripSpace=function(){return this.replace(/(^\s+)|(\s+$)/g,"")},String.prototype.fixFullWidthCharacters=function(){return this.replace(/ ([\u0080-\uffff])/g,"$1")},function(){if(IS_ON_IOS)Logger={info:function(){_log("INFO ("+Array.prototype.join.call(arguments," ")+")")},debug:function(){_log("DEBUG ("+Array.prototype.join.call(arguments," ")+")")},error:function(){_log("ERR ("+Array.prototype.join.call(arguments," ")+")")}};else{var t=require("winston"),e=require("fs");e.truncate("./log/debug.log",0),e.truncate("./log/raw.log",0),e.truncate("./log/data.log",0),Logger=new t.Logger({transports:[new t.transports.Console({json:!1,timestamp:!0}),new t.transports.File({filename:__dirname+"/log/debug.log",json:!1})],exitOnError:!1})}module.exports=Logger}(),function(){var t={INPUTTED:"inputted",LOGGED_IN:"logged_in"};LoginHandler=function(t,e,s,i){this.client=t,this.callback=i,this.username=e,this.password=s,this.checkedKicking=!1,this.checkedAttempts=!1,this.enterCounter=10},LoginHandler.prototype.start=function(){this.inputInfo(this.username,this.password),this.status=t.INPUTTED},LoginHandler.prototype.changeStatus=function(t){Logger.info("LoginHandler: "+this.status+" -> "+t),this.status=t},LoginHandler.prototype.inputInfo=function(t,e){this.client.write(t+"\r\n"+e+"\r\n")},LoginHandler.prototype.getTimeout=function(){return 15e3},LoginHandler.prototype.isEnded=function(){return this.status===t.LOGGED_IN},LoginHandler.prototype.end=function(){this.status=t.LOGGED_IN},LoginHandler.prototype.onData=function(e){switch(Logger.info("LoginHandler",this.status),this.status){case t.INPUTTED:-1!==e.getText(21,0,80).removeSpace().indexOf("ÂØÜÁ¢º‰∏çÂ∞çÊàñÁÑ°Ê≠§Â∏≥Ëôü")?(this.changeStatus(t.LOGGED_IN),this.callback({message:"wrong_username_or_password"})):-1!==e.getText(22,0,80).removeSpace().indexOf("ÊÇ®ÊÉ≥Âà™Èô§ÂÖ∂‰ªñÈáçË§áÁôªÂÖ•ÁöÑÈÄ£Á∑öÂóé")&&this.checkedKicking===!1?(this.client.write("n\r\n"),this.checkedKicking=!0):-1!==e.getText(23,0,80).removeSpace().indexOf("ÊÇ®Ë¶ÅÂà™Èô§‰ª•‰∏äÈåØË™§ÂòóË©¶ÁöÑË®òÈåÑÂóé")&&this.checkedAttempts===!1?(this.client.write("n\r\n"),this.checkedAttempts=!0):-1!==e.getText(23,0,80).removeSpace().indexOf("Êåâ‰ªªÊÑèÈçµÁπºÁ∫å")?this.client.write("x"):-1!==e.getAllTexts().join("").indexOf("(G)oodbye")&&(this.changeStatus(t.LOGGED_IN),this.callback(null))}},module.exports=LoginHandler}(),function(){var t={BEGINNING:"beginning",ENDING:"ending"};LogoutHandler=function(t,e){this.client=t,this.callback=e},LogoutHandler.prototype.start=function(){this.client.write("g\r\ny\r\n"),this.status=t.BEGINNING},LogoutHandler.prototype.changeStatus=function(t){Logger.info("LogoutHandler: "+this.status+" -> "+t),this.status=t},LogoutHandler.prototype.isEnded=function(){return this.status===t.ENDING},LogoutHandler.prototype.end=function(){this.status=t.ENDING},LogoutHandler.prototype.onData=function(e){Logger.info("LogoutHandler",this.status),this.status===t.BEGINNING&&-1!==e.getText(23,0,80).indexOf("Ê≠§ Ê¨° ÂÅú Áïô ÊôÇ Èñì")&&(this.callback(null),this.changeStatus(t.ENDING),this.client.write("\r\n"))},module.exports=LogoutHandler}(),function(){function t(t,e,s){var i=t.substr(0,7).match(/\d+$/);if(null!==i)var r=parseInt(i[0]);else var r=0/0;var a=t.substr(10,14).removeSpace(),n=t.substr(30,33).removeHeadingSpace().fixFullWidthCharacters(),o=t.substr(67,12),h=t.substr(24,3).removeSpace(),l="Àá"===t[9],c=t.substr(64,3).removeSpace(),u="",p=0;if("HOT"===c)u="hot";else if("ÁàÜ!"===c)switch(e){case 1:u="red";break;case 2:u="green";break;case 3:u="yellow";break;case 4:u="blue";break;case 5:u="purple";break;case 6:u="cyan";break;case 7:u="white"}else u="count",p=""===c?0:parseInt(c);var d=6===s;return isNaN(r)||0>=r||""===a||isNaN(p)||0>p||p>=100?null:{number:r,name:a,title:n,boardMasters:o,tag:h,viewerSign:u,viewerCount:p,hasUnread:l,favorited:d}}var e={BEGINNING:"beginning",HOT_LIST:"hot_list",WAIT_MORE:"wait_more",GOT_PAGE:"got_page",ENDING:"ending"};HotHandler=function(t,e){this.client=t,this.callback=e,this.boardList={type:"hot",items:[]},this.gotNumbers=[]},HotHandler.prototype.start=function(){this.enterHotList(),this.status=e.BEGINNING},HotHandler.prototype.enterHotList=function(){this.client.write("t1\r\n")},HotHandler.prototype.enterNewPage=function(){this.client.write(""),this.changeStatus(e.HOT_LIST)},HotHandler.prototype.changeStatus=function(t){Logger.info("HotHandler: "+this.status+" -> "+t),this.status=t},HotHandler.prototype.parseList=function(e,s){for(var i=this.boardList.items.length%20+3,r=[],a=i;23>a;a++)if(""!==e[a].removeSpace()){var n=t(e[a],s.getColor(a,65).frontground,s.getColor(a,10).frontground);r.push(n),null===n&&Logger.info(e[a])}return r},HotHandler.prototype.checkItems=function(t){this.boardList.items;for(var e=0,s=0;s<t.length;s++){var i=t[s];null===i||this.gotNumbers[i.number]||e++}return e},HotHandler.prototype.addItems=function(t){for(var e=this.boardList.items,s=0;s<t.length;s++){var i=t[s];null===i||this.gotNumbers[i.number]||(e.push(i),this.gotNumbers[i.number]=!0)}},HotHandler.prototype.isEnded=function(){return this.status===e.ENDING},HotHandler.prototype.end=function(){this.status=e.ENDING},HotHandler.prototype.onData=function(t){if(Logger.info("HotHandler",this.status),this.status!==e.ENDING&&(this.status===e.BEGINNING&&"Áúã Êùø Âàó"==t.getText(0,3,8)&&this.changeStatus(e.HOT_LIST),this.status===e.HOT_LIST||this.status===e.WAIT_MORE)){for(var s=this.parseList(t.getAllTexts(),t),i=0;i<s.length;i++)if(null===s[i])return;var r=this.checkItems(s);0===r?(this.callback(null,this.boardList),this.changeStatus(e.ENDING)):r===s.length&&(this.addItems(s),this.enterNewPage())}},module.exports=HotHandler}(),function(){function t(t){var e=t.substring(33,80).fixFullWidthCharacters(),s=/^.*\[(.*)\]/,i=s.exec(e),r=i?i[1]:"",a=e.replace(s,"").stripSpace(),n=t.substring(17,30).removeSpace(),o=t.substring(2,7).removeSpace(),h=0,l=!1;"‚òÖ"===o?l=!0:h=parseInt(o);var c=t.substring(9,11).removeSpace(),u=0;u="ÁàÜ"===c?100:"X"===c[0]?"X"===c[1]?-100:-10*parseInt(c[1]):""===c?0:parseInt(c);var p="normal";":"===t[31]?p="reply":"ËΩâ"===t[31]?p="xpost":"-"===n&&(p="deleted");var d="other";switch(t[8]){case"+":d="unread";break;case"~":d="unreadComment";break;case" ":d="normal";break;case"!":d="locked"}return!l&&(0>=h||isNaN(h))||""===n||""===a?null:{title:a,tag:r,author:n,score:u,number:h,type:p,pinned:l,status:d}}function e(t){for(var e=0,s=t.length-1;s>=0&&t[s].pinned!==!1;s--)t[s].number=e,e--}function s(t,e){function s(t){if(e.score){var s=e.score;if(s>=0){if(t.score<s)return!1}else if(s-t.score<-10)return!1}if(e.title){var i=e.title.toLowerCase(),r=("["+t.tag+"] "+t.title).toLowerCase();if(-1===r.indexOf(i))return!1}if(e.author){var a=e.author.toLowerCase();if(-1===t.author.toLowerCase().indexOf(a))return!1}return!0}for(var i=0;i<t.length;i++)if(s(t[i])===!1)return!1;return!0}var i={BEGINNING:"beginning",GETTING_INFO:"getting_info",SEARCHING:"searching",JUMPING:"jumping",GETTING_ARTICLES:"getting_articles",ENDING:"ending"};BoardHandler=function(t,e,s,i,r){4===arguments.length&&(r=i,i=s,s={}),this.client=t,this.name=e,this.criteria=s,this.pivot=i,this.callback=r,this.board={name:e,articles:[]}},BoardHandler.prototype.start=function(){this.enterBoard(this.name),this.status=i.BEGINNING},BoardHandler.prototype.enterBoard=function(t){this.client.write("qs"+t+"\r\n")},BoardHandler.prototype.changeStatus=function(t){Logger.info("BoardHandler: "+this.status+" -> "+t),this.status=t},BoardHandler.prototype.parseAndMergeInfo=function(t){this.board.title=t[6].substr(21).fixFullWidthCharacters().removeTailingSpace(),this.board.boardMasters=t[7].substr(15).fixFullWidthCharacters().removeTailingSpace(),this.board.dislikable="Èñã Êîæ"===t[15].substr(6,3)},BoardHandler.prototype.parseArticles=function(e){var s=e.slice(3,23).map(function(e){return t(e)}).filter(function(t){return null!==t});return s},BoardHandler.prototype.isInBoard=function(){return this.status===i.GETTING_ARTICLES||this.status===i.ENDING},BoardHandler.prototype.isEnded=function(){return this.status===i.ENDING},BoardHandler.prototype.end=function(){this.status=i.ENDING},BoardHandler.prototype.onData=function(t){if(Logger.info("BoardHandler",this.status),this.status!==i.ENDING&&(this.status===i.BEGINNING&&(-1!==t.getText(0,60,80).removeSpace().toLowerCase().indexOf("ÁúãÊùø„Ää"+this.board.name.toLowerCase()+"„Äã")&&"  Êñá Á´† ÈÅ∏ ËÆÄ  (y) Âõû Êáâ(X) Êé® Êñá(^X) ËΩâ ÈåÑ (=[]<>) Áõ∏ Èóú ‰∏ª È°å(/?a) Êâæ Ê®ô È°å/ ‰Ωú ËÄÖ (b) ÈÄ≤ Êùø Áï´ Èù¢   "===t.getText(23,0,80)?(this.changeStatus(i.GETTING_INFO),this.client.write("i")):this.client.write("x")),this.status===i.GETTING_INFO&&t.getText(4,0,40).removeSpace().toLowerCase()==="„Ää"+this.board.name.toLowerCase()+"„ÄãÁúãÊùøË®≠ÂÆö"&&"Ë´ã Êåâ ‰ªª ÊÑè Èçµ Áπº Á∫å"===t.getText(23,33,46)&&(this.parseAndMergeInfo(t.getAllTexts()),this.changeStatus(i.SEARCHING),this.client.write("x")),this.status===i.SEARCHING&&"  Êñá Á´† ÈÅ∏ ËÆÄ  (y) Âõû Êáâ(X) Êé® Êñá(^X) ËΩâ ÈåÑ (=[]<>) Áõ∏ Èóú ‰∏ª È°å(/?a) Êâæ Ê®ô È°å/ ‰Ωú ËÄÖ (b) ÈÄ≤ Êùø Áï´ Èù¢   "===t.getText(23,0,80)&&(this.criteria.title&&this.client.write("/"+this.criteria.title+"\r\n"),this.criteria.score&&this.client.write("Z"+this.criteria.score+"\r\n"),this.criteria.author&&this.client.write("a"+this.criteria.author+"\r\n"),this.changeStatus(i.JUMPING)),this.status===i.JUMPING&&"[ ‚Üê] Èõ¢ Èñã [ ‚Üí] Èñ± ËÆÄ [Ctrl-P] Áôº Ë°® Êñá Á´† [d] Âà™ Èô§ [z] Á≤æ ËèØ ÂçÄ [i] Áúã Êùø Ë≥á Ë®ä/ Ë®≠ ÂÆö [h] Ë™™ Êòé   "===t.getText(1,0,80)&&(null!==this.pivot?this.client.write(this.pivot+"\r\n"):this.client.write("1\r\nk"),this.changeStatus(i.GETTING_ARTICLES)),Logger.info("\n@@@\n"+t.getAllTexts()+"\n@@@\n"),this.status===i.GETTING_ARTICLES&&"[ ‚Üê] Èõ¢ Èñã [ ‚Üí] Èñ± ËÆÄ [Ctrl-P] Áôº Ë°® Êñá Á´† [d] Âà™ Èô§ [z] Á≤æ ËèØ ÂçÄ [i] Áúã Êùø Ë≥á Ë®ä/ Ë®≠ ÂÆö [h] Ë™™ Êòé   "===t.getText(1,0,80))){var r=!1;if(null===this.pivot)r=!0;else for(var a=0;a<t.rows;a++){var n=t.getText(a,0,80);n.substring(2,7).removeSpace()===this.pivot+""&&(r=!0)}if(r===!0){var o=this.parseArticles(t.getAllTexts()),h=s(o,this.criteria);h&&(this.board.articles=this.board.articles.concat(o),e(this.board.articles),this.callback(null,this.board),this.changeStatus(i.ENDING))}}},module.exports=BoardHandler}(),function(){function t(t){var e=/\d+%/.exec(t),s=0/0;null!==e&&(s=parseInt(e[0]));var i=/(\d{2,5})~(\d{2,5})/.exec(t),r=0/0,a=0/0;return null!==i&&(r=parseInt(i[1])-1,a=parseInt(i[2])),isNaN(s)||isNaN(r)||isNaN(a)?null:{progress:s,startLine:r,endLine:a}}function e(t){var e=t[0].fixFullWidthCharacters(),s=t[1].fixFullWidthCharacters(),i=t[2].fixFullWidthCharacters(),r=/‰ΩúËÄÖ  (.*) \(/.exec(e),a=r?r[1]:"",n=/‰ΩúËÄÖ  .* \((.*)\)/.exec(e),o=n?n[1]:"",h=/Ê®ôÈ°å  (Re: |Fw: )?\[(.*)\]/.exec(s),l=h?h[2]:"",c=/Ê®ôÈ°å  (Re: |Fw: )?(\[.*\])? (.*)/.exec(s),u=c?c[3].removeTailingSpace():"",p=/ÊôÇÈñì  (.*)/.exec(i),d="";if(null!==p){var f=new Date(p[1]),m=new Date(f.getTime()+288e5);d=m.toISOString()}return{author:a,authorNickname:o,tag:l,title:u,date:d}}function s(t){if(0===t.length)return"";for(var e=t[0],s=1;s<t.length;s++){var i=!0,r=t[s-1].substring(0,78).match(/ *$/)[0],a=t[s].match(/^ */)[0];r.length+a.length<2&&(i=!1);var n=/(,|Ôºå)\s*$/,o=t[s-1].substring(0,78).match(n);null!==o&&a.length<2&&(e=e.replace(n,"$1"),i=!1),i===!0&&(e+="\n"),e+=t[s]}return e}function i(t){for(var e=[],i=t,r={type:"normal",texts:[]},a=0;a<i.length;a++){if(":"===i[a][0]||"‚Äª"===i[a][0])var n="quote",o=i[a].substr(1);else var n="normal",o=i[a];r.type!==n?(e.push({type:r.type,text:s(r.texts)}),r={type:n,texts:[o]}):r.texts.push(o)}return e.push({type:r.type,text:s(r.texts)}),e=e.filter(function(t){return""!==t.text})}function r(e){for(var r=e.map(function(t){return t.fixFullWidthCharacters()}),a=[],n=r.indexOf("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  "),o=n+1;o<r.length;o++)if(void 0!==r[o]&&-1===r[o].indexOf("ÁÄèË¶Ω Á¨¨")){if(null!==r[o].match(/^‚Äª Áôº‰ø°Á´ô:/)){o+=2;break}a.push(e[o])}for(var h=[],l=[];o<r.length&&null===t(r[o]);o++)if("‚Äª"!==r[0]){var c=/^(Êé®|Âôì|‚Üí)\s*(.*?):(.*)\d\d\/\d\d \d\d:\d\d  $/.exec(r[o]);if(null!==c){l.length>0&&(h.push({type:"authorComment",author:"",content:s(l).removeTailingSpace()}),l=[]);var u="neutral";"Êé®"===c[1]&&(u="like"),"Âôì"===c[1]&&(u="dislike"),h.push({type:u,author:c[2],content:c[3].removeTailingSpace()})}else l.push(r[o])}return l.length>0&&h.push({type:"authorComment",author:"",content:s(l)}),{content:i(a.map(function(t){return t.fixFullWidthCharacters()})),comments:h}}var a={BEGINNING:"beginning",SELECTING_ITEM:"selecting_item",GETTING_URL:"getting_url",GETTING_ARTICLE:"getting_article",GETTING_MORE:"getting_more",ENDING:"ending"};ArticleHandler=function(t,e,s,i,r,a){5===arguments.length&&(a=r,r=i,i=s,s={}),this.client=t,this.callback=r,this.progressCallback=a,this.prevProgress=0,this.boardName=e,this.criteria=s,this.articleNum=i,this.article={comments:[]},this.cachedTexts=[]},ArticleHandler.prototype.start=function(){this.boardHandler=new BoardHandler(this.client,this.boardName,this.criteria,null,function(){}),this.boardHandler.start(),this.status=a.BEGINNING},ArticleHandler.prototype.changeStatus=function(t){Logger.info("ArticleHandler: "+this.status+" -> "+t),this.status=t},ArticleHandler.prototype.nextPage=function(){this.status!==a.ENDING&&this.client.write("jjjjj")},ArticleHandler.prototype.isSelected=function(){return this.status===a.SELECTING_ITEM},ArticleHandler.prototype.isEnded=function(){return this.status===a.ENDING},ArticleHandler.prototype.end=function(){this.status=a.ENDING},ArticleHandler.prototype.onData=function(s){if(Logger.info("ArticleHandler",this.status),this.status!==a.ENDING)if(this.status===a.BEGINNING&&(this.boardHandler.onData(s),this.boardHandler.isInBoard()))if(this.changeStatus(a.SELECTING_ITEM),this.articleNum>0)this.client.write(this.articleNum+"\r\n");else{for(var i="k",n=0;n<-this.articleNum;n++)i+="k";this.client.write("1\r\n"+i)}else{if(this.status===a.SELECTING_ITEM&&(this.changeStatus(a.GETTING_URL),this.client.write("Q")),this.status===a.GETTING_URL){var o=s.getAllTexts(),h=o.indexOf(" ‚îå ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îÄ ‚îê  ");if(-1!==h){var l=o[h+2].fixFullWidthCharacters(),c=l.match(/http:\/\/.*\.html/);this.article.url=null===c?"":c[0];var l=o[h+1],u=l.match(/#[a-zA-Z0-9]{8}/);this.article.id=null===u?"":u[0],this.changeStatus(a.GETTING_ARTICLE),this.client.write("xxx[C")}}if(this.status===a.GETTING_ARTICLE||this.status===a.GETTING_MORE){var p=t(s.getText(23,0,80));if(null!==p&&p.endLine>=this.cachedTexts.length){this.progressCallback(p.progress),p.progress>this.prevProgress&&(this.prevProgress=p.progress,this.client.setTimeout(1e3));for(var n=p.startLine;n<=p.endLine;n++)this.cachedTexts[n]=s.getText(n-p.startLine,0,80);if(100===p.progress){var d=e(this.cachedTexts),f=r(this.cachedTexts);this.article.title=d.title,this.article.tag=d.tag,this.article.author=d.author,this.article.authorNickname=d.authorNickname,this.article.date=d.date,this.article.content=f.content,this.article.comments=f.comments,this.callback(null,this.article),this.changeStatus(a.ENDING)}else this.nextPage()}}}},module.exports=ArticleHandler}(),function(){function t(t,e){var s=t.substr(0,7).match(/\d+$/);if(null!==s)var i=parseInt(s[0]);else var i=0/0;var r=t.substr(10,14).removeSpace(),a=t.substr(30,33).removeHeadingSpace().fixFullWidthCharacters(),n=t.substr(67,12),o=t.substr(24,3).removeSpace(),h="Àá"===t[9],l=t.substr(64,3).removeSpace(),c="",u=0;if("HOT"===l)c="hot";else if("ÁàÜ!"===l)switch(e){case 1:c="red";break;case 2:c="green";break;case 3:c="yellow";break;case 4:c="blue";break;case 5:c="purple";break;case 6:c="cyan";break;case 7:c="white"}else c="count",u=""===l?0:parseInt(l);return isNaN(i)||0>=i?null:"MyFavFolder"===r?{type:"directory",number:i,name:a}:"------------"===r?{type:"separator",number:i}:""===r||isNaN(u)||0>u||u>=100?null:{type:"boardItem",number:i,boardItem:{number:i,name:r,title:a,boardMasters:n,tag:o,viewerSign:c,viewerCount:u,hasUnread:h,favorited:!0}}}var e={BEGINNING:"beginning",FOLLOWING_PATH:"following_path",FAVORITES_LIST:"favorites_list",WAIT_MORE:"wait_more",GOT_PAGE:"got_page",ENDING:"ending"};FavoritesHandler=function(t,e,s){this.client=t,this.path=e,this.callback=s,this.boardList={type:"favorites",items:[]},this.gotNumbers=[]},FavoritesHandler.prototype.start=function(){this.enterList(),this.status=e.BEGINNING},FavoritesHandler.prototype.enterList=function(){this.client.write("f1\r\n")},FavoritesHandler.prototype.enterNewPage=function(){this.client.write(""),this.changeStatus(e.FAVORITES_LIST)},FavoritesHandler.prototype.changeStatus=function(t){Logger.info("FavoritesHandler: "+this.status+" -> "+t),this.status=t},FavoritesHandler.prototype.parseList=function(e,s){for(var i=this.boardList.items.length%20+3,r=[],a=i;23>a;a++)if(""!==e[a].removeSpace()){var n=t(e[a],s.getColor(a,65).frontground,s.getColor(a,10).frontground);null===n&&Logger.info(e[a]),r.push(n)}return r},FavoritesHandler.prototype.checkItems=function(t){this.boardList.items;for(var e=0,s=0;s<t.length;s++){var i=t[s];null===i||this.gotNumbers[i.number]||e++}return e},FavoritesHandler.prototype.addItems=function(t){for(var e=this.boardList.items,s=0;s<t.length;s++){var i=t[s];null===i||this.gotNumbers[i.number]||(e.push(i),this.gotNumbers[i.number]=!0)}},FavoritesHandler.prototype.isEnded=function(){return this.status===e.ENDING},FavoritesHandler.prototype.end=function(){this.status=e.ENDING},FavoritesHandler.prototype.isInList=function(){return this.status===e.FAVORITES_LIST},FavoritesHandler.prototype.onData=function(t){if(Logger.info("FavoritesHandler",this.status),this.status!==e.ENDING){if(Logger.info(t.getText(0,0,80)),this.status===e.BEGINNING&&"Áúã Êùø Âàó"==t.getText(0,3,8)&&this.changeStatus(e.FOLLOWING_PATH),this.status===e.FOLLOWING_PATH)if(0===this.path.length)this.changeStatus(e.FAVORITES_LIST);else{var s=this.path.shift();this.client.write(s+"\r\n\r\n")}if(this.status===e.FAVORITES_LIST||this.status===e.WAIT_MORE){for(var i=this.parseList(t.getAllTexts(),t),r=0;r<i.length;r++)if(null===i[r])return;var a=this.checkItems(i);0===a?(this.callback(null,this.boardList),this.changeStatus(e.ENDING)):a===i.length&&(this.addItems(i),this.enterNewPage())}}},module.exports=FavoritesHandler}(),function(){var t={BEGINNING:"beginning",ADDING_BOARD:"adding_board",ENDING:"ending"};FavoritesAddHandler=function(t,e,s,i){this.client=t,this.path=e,this.boardName=s,this.callback=i},FavoritesAddHandler.prototype.start=function(){this.favoritesHandler=new FavoritesHandler(this.client,this.path,this.callback),this.favoritesHandler.start(),this.status=t.BEGINNING},FavoritesAddHandler.prototype.changeStatus=function(t){Logger.info("FavoritesHandler: "+this.status+" -> "+t),this.status=t},FavoritesAddHandler.prototype.isEnded=function(){return this.status===t.ENDING},FavoritesAddHandler.prototype.end=function(){this.status=t.ENDING},FavoritesAddHandler.prototype.onData=function(e){Logger.info("FavoritesAddHandler",this.status),this.status!==t.ENDING&&(this.status===t.BEGINNING&&(this.favoritesHandler.isInList()?this.changeStatus(t.ADDING_BOARD):this.favoritesHandler.onData(e)),this.status===t.ADDING_BOARD&&(this.client.write("a"+this.boardName+"\r\n"),this.callback(null),this.changeStatus(t.ENDING)))},module.exports=FavoritesAddHandler}(),function(){var t={BEGINNING:"beginning",REMOVING_BOARD:"removing_board",ENDING:"ending"};FavoritesRemoveHandler=function(t,e,s,i){this.client=t,this.path=e,this.number=s,this.callback=i},FavoritesRemoveHandler.prototype.start=function(){this.favoritesHandler=new FavoritesHandler(this.client,this.path,this.callback),this.favoritesHandler.start(),this.status=t.BEGINNING},FavoritesRemoveHandler.prototype.changeStatus=function(t){Logger.info("FavoritesHandler: "+this.status+" -> "+t),this.status=t},FavoritesRemoveHandler.prototype.isEnded=function(){return this.status===t.ENDING},FavoritesRemoveHandler.prototype.end=function(){this.status=t.ENDING},FavoritesRemoveHandler.prototype.onData=function(e){Logger.info("FavoritesRemoveHandler",this.status),this.status!==t.ENDING&&(this.status===t.BEGINNING&&(this.favoritesHandler.isInList()?this.changeStatus(t.REMOVING_BOARD):this.favoritesHandler.onData(e)),this.status===t.REMOVING_BOARD&&(this.client.write(this.number+"\r\ndy\r\n"),this.callback(null),this.changeStatus(t.ENDING)))},module.exports=FavoritesRemoveHandler}(),function(){var t={BEGINNING:"beginning",MOVING_BOARD:"moving_board",ENDING:"ending"};FavoritesMoveHandler=function(t,e,s,i,r){this.client=t,this.path=e,this.from=s,this.to=i,this.callback=r},FavoritesMoveHandler.prototype.start=function(){this.favoritesHandler=new FavoritesHandler(this.client,this.path,this.callback),this.favoritesHandler.start(),this.status=t.BEGINNING},FavoritesMoveHandler.prototype.changeStatus=function(t){Logger.info("FavoritesHandler: "+this.status+" -> "+t),this.status=t},FavoritesMoveHandler.prototype.isEnded=function(){return this.status===t.ENDING},FavoritesMoveHandler.prototype.end=function(){this.status=t.ENDING},FavoritesMoveHandler.prototype.onData=function(e){Logger.info("FavoritesMoveHandler",this.status),this.status!==t.ENDING&&(this.status===t.BEGINNING&&(this.favoritesHandler.isInList()?this.changeStatus(t.MOVING_BOARD):this.favoritesHandler.onData(e)),this.status===t.MOVING_BOARD&&(this.client.write(this.from+"\r\nM"+this.to+"\r\n"),this.callback(null),this.changeStatus(t.ENDING)))},module.exports=FavoritesMoveHandler}(),function(){var t={BEGINNING:"beginning",POSTING:"posting",ENDING:"ending"};CommentHandler=function(t,e,s,i,r,a){switch(this.client=t,this.callback=a,this.content=r,this.type=i,i){case"like":this.typeNum=1;break;case"dislike":this.typeNum=2;break;case"neutral":this.typeNum=3}this.boardName=e,this.articleNum=s},CommentHandler.prototype.start=function(){this.articleHandler=new ArticleHandler(this.client,this.boardName,this.articleNum,function(){},function(){}),this.articleHandler.start(),this.status=t.BEGINNING},CommentHandler.prototype.changeStatus=function(t){Logger.info("CommentHandler: "+this.status+" -> "+t),this.status=t},CommentHandler.prototype.isEnded=function(){return this.status===t.ENDING},CommentHandler.prototype.end=function(){this.status=t.ENDING},CommentHandler.prototype.onData=function(e){if(Logger.info("CommentHandler",this.status),this.status!==t.ENDING&&(this.status===t.BEGINNING&&(this.articleHandler.isSelected()?(this.changeStatus(t.POSTING),this.client.write("%")):this.articleHandler.onData(e)),this.status===t.POSTING))if("‰Ωú ËÄÖ Êú¨ ‰∫∫"===e.getText(22,1,8)||"ÊôÇ Èñì Â§™ Ëøë"===e.getText(22,1,8))this.client.write(this.content+"\r\ny\r\n"),this.callback(null),this.changeStatus(t.ENDING);else if("ÊÇ® Ë¶∫ Âæó ÈÄô ÁØá Êñá Á´†"===e.getText(23,1,14))this.client.write(this.typeNum+""),this.client.write(this.content+"\r\ny\r\n"),this.callback(null),this.changeStatus(t.ENDING);else if(e.getText(23,0,80).indexOf("Êú¨ Êùø Á¶Å Ê≠¢ Âø´ ÈÄü ÈÄ£ Á∫å Êé® Êñá")){var s=e.getText(23,0,80).removeSpace(),i=/Ë´ãÂÜçÁ≠â\s*(\d+)\s*Áßí/,r=s.match(i);if(null!==r){var a=parseInt(r[1]);this.callback({message:"comment_delayed",delay:a}),this.changeStatus(t.ENDING)}}},module.exports=CommentHandler}(),function(){function t(){this._events=this._events||{}}function e(t,e,s,i){t.addEventListener(e,s,i||!1)}function s(t,e,s,i){t.removeEventListener(e,s,i||!1)}function i(t){return t.preventDefault&&t.preventDefault(),t.returnValue=!1,t.stopPropagation&&t.stopPropagation(),t.cancelBubble=!0,!1}function r(t,e){function s(){this.constructor=t}s.prototype=e.prototype,t.prototype=new s}function a(t){var e=t.getElementsByTagName("body")[0],s=t.createElement("span");s.innerHTML="hello world",e.appendChild(s);var i=s.scrollWidth;s.style.fontWeight="bold";var r=s.scrollWidth;return e.removeChild(s),i!==r}function n(t,e){for(var s=t.length;s--;)if(t[s]===e)return s;return-1}function o(t){return t>="„êÄ"&&"Èæø">=t?!0:t.charCodeAt(0)>=256?!0:t>="ÔºÅ"&&"Ôææ">=t||t>="ÔøÇ"&&"Ôøá">=t||t>="Ôøä"&&"Ôøè">=t||t>="Ôøí"&&"Ôøó">=t||t>="Ôøö"&&"Ôøú">=t||t>="Ôø†"&&"Ôø¶">=t||t>="Ôø®"&&"ÔøÆ">=t}function h(t,e,s){var i=t<<16|e<<8|s;if(null!=h._cache[i])return h._cache[i];for(var r,a,n,o,l,c=1/0,u=-1,p=0;p<Terminal.vcolors.length;p++){if(r=Terminal.vcolors[p],a=r[0],n=r[1],o=r[2],l=h.distance(t,e,s,a,n,o),0===l){u=p;break}c>l&&(c=l,u=p)}return h._cache[i]=u}function l(t,e,s){if(t.forEach)return t.forEach(e,s);for(var i=0;i<t.length;i++)e.call(s,t[i],i,t)}function c(t){if(Object.keys)return Object.keys(t);var e,s=[];for(e in t)Object.prototype.hasOwnProperty.call(t,e)&&s.push(e);return s}var u=this.document;t.prototype.addListener=function(t,e){this._events[t]=this._events[t]||[],this._events[t].push(e)},t.prototype.on=t.prototype.addListener,t.prototype.removeListener=function(t,e){if(this._events[t])for(var s=this._events[t],i=s.length;i--;)if(s[i]===e||s[i].listener===e)return s.splice(i,1),void 0},t.prototype.off=t.prototype.removeListener,t.prototype.removeAllListeners=function(t){this._events[t]&&delete this._events[t]},t.prototype.once=function(t,e){function s(){var i=Array.prototype.slice.call(arguments);return this.removeListener(t,s),e.apply(this,i)}return s.listener=e,this.on(t,s)},t.prototype.emit=function(t){if(this._events[t])for(var e=Array.prototype.slice.call(arguments,1),s=this._events[t],i=s.length,r=0;i>r;r++)s[r].apply(this,e)},t.prototype.listeners=function(t){return this._events[t]=this._events[t]||[]};var p=0,d=1,f=2,m=3,y=4,g=5,b=6;Terminal=function(e){var s=this;if(!(this instanceof Terminal))return new Terminal(arguments[0],arguments[1],arguments[2]);t.call(this),"number"==typeof e&&(e={cols:arguments[0],rows:arguments[1],handler:arguments[2]}),e=e||{},l(c(Terminal.defaults),function(t){null==e[t]&&(e[t]=Terminal.options[t],Terminal[t]!==Terminal.defaults[t]&&(e[t]=Terminal[t])),s[t]=e[t]}),8===e.colors.length?e.colors=e.colors.concat(Terminal._colors.slice(8)):16===e.colors.length?e.colors=e.colors.concat(Terminal._colors.slice(16)):10===e.colors.length?e.colors=e.colors.slice(0,-2).concat(Terminal._colors.slice(8,-2),e.colors.slice(-2)):18===e.colors.length&&(e.colors=e.colors.concat(Terminal._colors.slice(16,-2),e.colors.slice(-2))),this.colors=e.colors,this.options=e,this.parent=e.body||e.parent||(u?u.getElementsByTagName("body")[0]:null),this.cols=e.cols||e.geometry[0],this.rows=e.rows||e.geometry[1],e.handler&&this.on("data",e.handler),this.ybase=0,this.ydisp=0,this.x=0,this.y=0,this.cursorState=0,this.cursorHidden=!1,this.convertEol,this.state=0,this.queue="",this.scrollTop=0,this.scrollBottom=this.rows-1,this.applicationKeypad=!1,this.applicationCursor=!1,this.originMode=!1,this.insertMode=!1,this.wraparoundMode=!1,this.normal=null,this.prefixMode=!1,this.selectMode=!1,this.visualMode=!1,this.searchMode=!1,this.searchDown,this.entry="",this.entryPrefix="",this._real,this._selected,this._textarea,this.charset=null,this.gcharset=null,this.glevel=0,this.charsets=[null],this.decLocator,this.x10Mouse,this.vt200Mouse,this.vt300Mouse,this.normalMouse,this.mouseEvents,this.sendFocus,this.utfMouse,this.sgrMouse,this.urxvtMouse,this.element,this.children,this.refreshStart,this.refreshEnd,this.savedX,this.savedY,this.savedCols,this.readable=!0,this.writable=!0,this.defAttr=131840,this.curAttr=this.defAttr,this.params=[],this.currentParam=0,this.prefix="",this.postfix="",this.lines=[];for(var i=this.rows;i--;)this.lines.push(this.blankLine());this.tabs,this.setupStops()},r(Terminal,t),Terminal.prototype.eraseAttr=function(){return-512&this.defAttr|511&this.curAttr},Terminal.tangoColors=["#2e3436","#cc0000","#4e9a06","#c4a000","#3465a4","#75507b","#06989a","#d3d7cf","#555753","#ef2929","#8ae234","#fce94f","#729fcf","#ad7fa8","#34e2e2","#eeeeec"],Terminal.xtermColors=["#000000","#cd0000","#00cd00","#cdcd00","#0000ee","#cd00cd","#00cdcd","#e5e5e5","#7f7f7f","#ff0000","#00ff00","#ffff00","#5c5cff","#ff00ff","#00ffff","#ffffff"],Terminal.colors=function(){function t(t,s,r){i.push("#"+e(t)+e(s)+e(r))}function e(t){return t=t.toString(16),t.length<2?"0"+t:t}var s,i=Terminal.tangoColors.slice(),r=[0,95,135,175,215,255];for(s=0;216>s;s++)t(r[0|s/36%6],r[0|s/6%6],r[s%6]);for(s=0;24>s;s++)r=8+10*s,t(r,r,r);return i}(),Terminal.colors[256]="#000000",Terminal.colors[257]="#f0f0f0",Terminal._colors=Terminal.colors.slice(),Terminal.vcolors=function(){for(var t,e=[],s=Terminal.colors,i=0;256>i;i++)t=parseInt(s[i].substring(1),16),e.push([255&t>>16,255&t>>8,255&t]);return e}(),Terminal.defaults={colors:Terminal.colors,convertEol:!1,termName:"xterm",geometry:[80,24],cursorBlink:!0,visualBell:!1,popOnBell:!1,scrollback:1e3,screenKeys:!1,debug:!1,useStyle:!1},Terminal.options={},l(c(Terminal.defaults),function(t){Terminal[t]=Terminal.defaults[t],Terminal.options[t]=Terminal.defaults[t]}),Terminal.focus=null,Terminal.prototype.focus=function(){Terminal.focus!==this&&(Terminal.focus&&Terminal.focus.blur(),this.sendFocus&&this.send("[I"),this.showCursor(),Terminal.focus=this)},Terminal.prototype.blur=function(){Terminal.focus===this&&(this.cursorState=0,this.refresh(this.y,this.y),this.sendFocus&&this.send("[O"),Terminal.focus=null)},Terminal.prototype.initGlobal=function(){var t=this.document;Terminal._boundDocs=Terminal._boundDocs||[],~n(Terminal._boundDocs,t)||(Terminal._boundDocs.push(t),Terminal.bindPaste(t),Terminal.bindKeys(t),Terminal.bindCopy(t),this.isIpad&&Terminal.fixIpad(t),this.useStyle&&Terminal.insertStyle(t,this.colors[256],this.colors[257]))},Terminal.bindPaste=function(t){var s=t.defaultView;e(s,"paste",function(t){var e=Terminal.focus;return e?(t.clipboardData?e.send(t.clipboardData.getData("text/plain")):e.context.clipboardData&&e.send(e.context.clipboardData.getData("Text")),e.element.contentEditable="inherit",i(t)):void 0})},Terminal.bindKeys=function(t){e(t,"keydown",function(t){if(Terminal.focus){var e=t.target||t.srcElement;if(e)return e===Terminal.focus.element||e===Terminal.focus.context||e===Terminal.focus.document||e===Terminal.focus.body||e===Terminal._textarea||e===Terminal.focus.parent?Terminal.focus.keyDown(t):void 0}},!0),e(t,"keypress",function(t){if(Terminal.focus){var e=t.target||t.srcElement;if(e)return e===Terminal.focus.element||e===Terminal.focus.context||e===Terminal.focus.document||e===Terminal.focus.body||e===Terminal._textarea||e===Terminal.focus.parent?Terminal.focus.keyPress(t):void 0}},!0),e(t,"mousedown",function(t){if(Terminal.focus){var e=t.target||t.srcElement;if(e){do if(e===Terminal.focus.element)return;while(e=e.parentNode);Terminal.focus.blur()}}})},Terminal.bindCopy=function(t){var s=t.defaultView;e(s,"copy",function(){var t=Terminal.focus;if(t&&t._selected){var e=t.getCopyTextarea(),s=t.grabText(t._selected.x1,t._selected.x2,t._selected.y1,t._selected.y2);t.emit("copy",s),e.focus(),e.textContent=s,e.value=s,e.setSelectionRange(0,s.length),T(function(){t.element.focus(),t.focus()},1)}})},Terminal.fixIpad=function(t){var e=t.createElement("textarea");e.style.position="absolute",e.style.left="-32000px",e.style.top="-32000px",e.style.width="0px",e.style.height="0px",e.style.opacity="0",e.style.backgroundColor="transparent",e.style.borderStyle="none",e.style.outlineStyle="none",t.getElementsByTagName("body")[0].appendChild(e),Terminal._textarea=e,T(function(){e.focus()},1e3)},Terminal.insertStyle=function(t,e,s){var i=t.getElementById("term-style");if(!i){var r=t.getElementsByTagName("head")[0];if(r){var i=t.createElement("style");i.id="term-style",i.innerHTML=".terminal {\n  float: left;\n  border: "+e+" solid 5px;\n"+'  font-family: "STHeiti", "DejaVu Sans Mono", "Liberation Mono", monospace;\n'+"  font-size: 22px;\n"+"  color: "+s+";\n"+"  background: "+e+";\n"+"}\n"+"\n"+".terminal-cursor {\n"+"  color: "+e+";\n"+"  background: "+s+";\n"+"}\n",r.insertBefore(i,r.firstChild)}}},Terminal.prototype.open=function(t){var s,i=this,r=0;if(this.parent=t||this.parent,!this.parent)throw new Error("Terminal requires a parent element.");for(this.context=this.parent.ownerDocument.defaultView,this.document=this.parent.ownerDocument,this.body=this.document.getElementsByTagName("body")[0],this.context.navigator&&this.context.navigator.userAgent&&(this.isMac=!!~this.context.navigator.userAgent.indexOf("Mac"),this.isIpad=!!~this.context.navigator.userAgent.indexOf("iPad"),this.isMSIE=!!~this.context.navigator.userAgent.indexOf("MSIE")),this.element=this.document.createElement("div"),this.element.className="terminal",this.element.style.outline="none",this.element.setAttribute("tabindex",0),this.element.style.backgroundColor=this.colors[256],this.element.style.color=this.colors[257],this.children=[];r<this.rows;r++)s=this.document.createElement("div"),this.element.appendChild(s),this.children.push(s);
this.parent.appendChild(this.element),this.refresh(0,this.rows-1),this.initGlobal(),this.focus(),this.startBlink(),e(this.element,"focus",function(){i.focus(),i.isIpad&&Terminal._textarea.focus()}),e(this.element,"mousedown",function(){i.focus()}),e(this.element,"mousedown",function(t){var e=null!=t.button?+t.button:null!=t.which?t.which-1:null;i.isMSIE&&(e=1===e?0:4===e?1:e),2===e&&(i.element.contentEditable="true",T(function(){i.element.contentEditable="inherit"},1))},!0),this.bindMouse(),null==Terminal.brokenBold&&(Terminal.brokenBold=a(this.document)),T(function(){i.element.focus()},100)},Terminal.prototype.bindMouse=function(){function t(t){var e,s;if(e=o(t),s=h(t))switch(n(e,s),t.type){case"mousedown":u=e;break;case"mouseup":u=32;break;case p:}}function r(t){var e,s=u;e=h(t),e&&(s+=32,n(s,e))}function a(t,e){if(c.utfMouse){if(2047===e)return t.push(0);127>e?t.push(e):(e>2047&&(e=2047),t.push(192|e>>6),t.push(128|63&e))}else{if(255===e)return t.push(0);e>127&&(e=127),t.push(e)}}function n(t,e){if(c.vt300Mouse){t&=3,e.x-=32,e.y-=32;var s="[24";if(0===t)s+="1";else if(1===t)s+="3";else if(2===t)s+="5";else{if(3===t)return;s+="0"}return s+="~["+e.x+","+e.y+"]\r",c.send(s),void 0}if(c.decLocator)return t&=3,e.x-=32,e.y-=32,0===t?t=2:1===t?t=4:2===t?t=6:3===t&&(t=3),c.send("["+t+";"+(3===t?4:0)+";"+e.y+";"+e.x+";"+(e.page||0)+"&w"),void 0;if(c.urxvtMouse)return e.x-=32,e.y-=32,e.x++,e.y++,c.send("["+t+";"+e.x+";"+e.y+"M"),void 0;if(c.sgrMouse)return e.x-=32,e.y-=32,c.send("[<"+(3===(3&t)?-4&t:t)+";"+e.x+";"+e.y+(3===(3&t)?"m":"M")),void 0;var s=[];a(s,t),a(s,e.x),a(s,e.y),c.send("[M"+v.fromCharCode.apply(v,s))}function o(t){var e,s,i,r,a;switch(t.type){case"mousedown":e=null!=t.button?+t.button:null!=t.which?t.which-1:null,c.isMSIE&&(e=1===e?0:4===e?1:e);break;case"mouseup":e=3;break;case"DOMMouseScroll":e=t.detail<0?64:65;break;case"mousewheel":e=t.wheelDeltaY>0?64:65}return s=t.shiftKey?4:0,i=t.metaKey?8:0,r=t.ctrlKey?16:0,a=s|i|r,c.vt200Mouse?a&=r:c.normalMouse||(a=0),e=32+(a<<2)+e}function h(t){var e,s,i,r,a;if(null!=t.pageX){for(e=t.pageX,s=t.pageY,a=c.element;a&&a!==c.document.documentElement;)e-=a.offsetLeft,s-=a.offsetTop,a="offsetParent"in a?a.offsetParent:a.parentNode;return i=c.element.clientWidth,r=c.element.clientHeight,e=Math.round(e/i*c.cols),s=Math.round(s/r*c.rows),0>e&&(e=0),e>c.cols&&(e=c.cols),0>s&&(s=0),s>c.rows&&(s=c.rows),e+=32,s+=32,{x:e,y:s,type:t.type===p?"mousewheel":t.type}}}var l=this.element,c=this,u=32,p="onmousewheel"in this.context?"mousewheel":"DOMMouseScroll";e(l,"mousedown",function(a){return c.mouseEvents?(t(a),c.focus(),c.vt200Mouse?(t({__proto__:a,type:"mouseup"}),i(a)):(c.normalMouse&&e(c.document,"mousemove",r),c.x10Mouse||e(c.document,"mouseup",function n(e){return t(e),c.normalMouse&&s(c.document,"mousemove",r),s(c.document,"mouseup",n),i(e)}),i(a))):void 0}),e(l,p,function(e){return!c.mouseEvents||c.x10Mouse||c.vt300Mouse||c.decLocator?void 0:(t(e),i(e))}),e(l,p,function(t){return c.mouseEvents||c.applicationKeypad?void 0:("DOMMouseScroll"===t.type?c.scrollDisp(t.detail<0?-5:5):c.scrollDisp(t.wheelDeltaY>0?-5:5),i(t))})},Terminal.prototype.destroy=function(){this.readable=!1,this.writable=!1,this._events={},this.handler=function(){},this.write=function(){},this.element.parentNode&&this.element.parentNode.removeChild(this.element)},Terminal.prototype.refresh=function(t,e){var s,i;e-t>=this.rows/2,i=this.cols,s=t,e>=this.lines.length&&(this.log("`end` is too large. Most likely a bad CSR."),e=this.lines.length-1)},Terminal.prototype._cursorBlink=function(){Terminal.focus===this&&(this.cursorState^=1,this.refresh(this.y,this.y))},Terminal.prototype.showCursor=function(){this.cursorState||(this.cursorState=1,this.refresh(this.y,this.y))},Terminal.prototype.startBlink=function(){if(this.cursorBlink){var t=this;this._blinker=function(){t._cursorBlink()},this._blink=x(this._blinker,500)}},Terminal.prototype.refreshBlink=function(){this.cursorBlink&&(clearInterval(this._blink),this._blink=x(this._blinker,500))},Terminal.prototype.scroll=function(){var t;++this.ybase===this.scrollback&&(this.ybase=0|this.ybase/2,this.lines=this.lines.slice(-(this.ybase+this.rows)+1)),this.ydisp=this.ybase,t=this.ybase+this.rows-1,t-=this.rows-1-this.scrollBottom,t===this.lines.length?this.lines.push(this.blankLine()):this.lines.splice(t,0,this.blankLine()),0!==this.scrollTop&&(0!==this.ybase&&(this.ybase--,this.ydisp=this.ybase),this.lines.splice(this.ybase+this.scrollTop,1)),this.updateRange(this.scrollTop),this.updateRange(this.scrollBottom)},Terminal.prototype.scrollDisp=function(t){this.ydisp+=t,this.ydisp>this.ybase?this.ydisp=this.ybase:this.ydisp<0&&(this.ydisp=0),this.refresh(0,this.rows-1)},Terminal.prototype.write=function(t){var e,s,i,r=t.length,a=0;this.refreshStart=this.y,this.refreshEnd=this.y,this.ybase!==this.ydisp&&(this.ydisp=this.ybase,this.maxRange());for(var n="",h=0;h<t.length;h++){var l=t.charCodeAt(h);n+=l>=256||256>l&&l>32?t[h]+" ":32==l?"B ":l+" "}for(;r>a;a++)switch(i=t[a],this.state){case p:switch(i){case"\b":this.x>0&&this.x--;break;case"":this.bell();break;case"\n":case"":case"\f":this.convertEol&&(this.x=0),this.y++,this.y>this.scrollBottom&&(this.y--,this.scroll());break;case"\r":this.x=0;break;case"\b":this.x>0&&this.x--;break;case"	":this.x=this.nextStop();break;case"":this.setgLevel(1);break;case"":this.setgLevel(0);break;case"":this.state=d;break;default:if(i>=" "){if(this.charset&&this.charset[i]&&(i=this.charset[i]),this.x>=this.cols&&(this.x=0,this.y++,this.y>this.scrollBottom&&(this.y--,this.scroll())),o(i)){if(e=this.y+this.ybase,this.cols<2||this.x>=this.cols){this.lines[e][this.x-1]=[this.curAttr," "];break}this.lines[e][this.x]=[this.curAttr," "],this.x++}this.lines[this.y+this.ybase][this.x]=[this.curAttr,i],this.x++,this.updateRange(this.y)}}break;case d:switch(i){case"[":this.params=[],this.currentParam=0,this.state=f;break;case"]":this.params=[],this.currentParam=0,this.state=m;break;case"P":this.params=[],this.currentParam=0,this.state=g;break;case"_":this.state=b;break;case"^":this.state=b;break;case"c":this.reset();break;case"E":this.x=0;case"D":this.index();break;case"M":this.reverseIndex();break;case"%":this.setgLevel(0),this.setgCharset(0,Terminal.charsets.US),this.state=p,a++;break;case"(":case")":case"*":case"+":case"-":case".":switch(i){case"(":this.gcharset=0;break;case")":this.gcharset=1;break;case"*":this.gcharset=2;break;case"+":this.gcharset=3;break;case"-":this.gcharset=1;break;case".":this.gcharset=2}this.state=y;break;case"/":this.gcharset=3,this.state=y,a--;break;case"N":break;case"O":break;case"n":this.setgLevel(2);break;case"o":this.setgLevel(3);break;case"|":this.setgLevel(3);break;case"}":this.setgLevel(2);break;case"~":this.setgLevel(1);break;case"7":this.saveCursor(),this.state=p;break;case"8":this.restoreCursor(),this.state=p;break;case"#":this.state=p,a++;break;case"H":this.tabSet();break;case"=":this.log("Serial port requested application keypad."),this.applicationKeypad=!0,this.state=p;break;case">":this.log("Switching back to normal keypad."),this.applicationKeypad=!1,this.state=p;break;default:this.state=p,this.error("Unknown ESC control: %s.",i)}break;case y:switch(i){case"0":s=Terminal.charsets.SCLD;break;case"A":s=Terminal.charsets.UK;break;case"B":s=Terminal.charsets.US;break;case"4":s=Terminal.charsets.Dutch;break;case"C":case"5":s=Terminal.charsets.Finnish;break;case"R":s=Terminal.charsets.French;break;case"Q":s=Terminal.charsets.FrenchCanadian;break;case"K":s=Terminal.charsets.German;break;case"Y":s=Terminal.charsets.Italian;break;case"E":case"6":s=Terminal.charsets.NorwegianDanish;break;case"Z":s=Terminal.charsets.Spanish;break;case"H":case"7":s=Terminal.charsets.Swedish;break;case"=":s=Terminal.charsets.Swiss;break;case"/":s=Terminal.charsets.ISOLatin,a++;break;default:s=Terminal.charsets.US}this.setgCharset(this.gcharset,s),this.gcharset=null,this.state=p;break;case m:if(""===i||""===i){switch(""===i&&a++,this.params.push(this.currentParam),this.params[0]){case 0:case 1:case 2:this.params[1]&&(this.title=this.params[1],this.handleTitle(this.title));break;case 3:break;case 4:case 5:break;case 10:case 11:case 12:case 13:case 14:case 15:case 16:case 17:case 18:case 19:break;case 46:break;case 50:break;case 51:break;case 52:break;case 104:case 105:case 110:case 111:case 112:case 113:case 114:case 115:case 116:case 117:case 118:}this.params=[],this.currentParam=0,this.state=p}else this.params.length?this.currentParam+=i:i>="0"&&"9">=i?this.currentParam=10*this.currentParam+i.charCodeAt(0)-48:";"===i&&(this.params.push(this.currentParam),this.currentParam="");break;case f:if("?"===i||">"===i||"!"===i){this.prefix=i;break}if(i>="0"&&"9">=i){this.currentParam=10*this.currentParam+i.charCodeAt(0)-48;break}if("$"===i||'"'===i||" "===i||"'"===i){this.postfix=i;break}if(this.params.push(this.currentParam),this.currentParam=0,";"===i)break;switch(this.state=p,i){case"A":this.cursorUp(this.params);break;case"B":this.cursorDown(this.params);break;case"C":this.cursorForward(this.params);break;case"D":this.cursorBackward(this.params);break;case"H":this.cursorPos(this.params);break;case"J":this.eraseInDisplay(this.params);break;case"K":this.eraseInLine(this.params);break;case"m":this.charAttributes(this.params);break;case"n":this.deviceStatus(this.params);break;case"@":this.insertChars(this.params);break;case"E":this.cursorNextLine(this.params);break;case"F":this.cursorPrecedingLine(this.params);break;case"G":this.cursorCharAbsolute(this.params);break;case"L":this.insertLines(this.params);break;case"M":this.deleteLines(this.params);break;case"P":this.deleteChars(this.params);break;case"X":this.eraseChars(this.params);break;case"`":this.charPosAbsolute(this.params);break;case"a":this.HPositionRelative(this.params);break;case"c":this.sendDeviceAttributes(this.params);break;case"d":this.linePosAbsolute(this.params);break;case"e":this.VPositionRelative(this.params);break;case"f":this.HVPosition(this.params);break;case"h":this.setMode(this.params);break;case"l":this.resetMode(this.params);break;case"r":this.setScrollRegion(this.params);break;case"s":this.saveCursor(this.params);break;case"u":this.restoreCursor(this.params);break;case"I":this.cursorForwardTab(this.params);break;case"S":this.scrollUp(this.params);break;case"T":this.params.length<2&&!this.prefix&&this.scrollDown(this.params);break;case"Z":this.cursorBackwardTab(this.params);break;case"b":this.repeatPrecedingCharacter(this.params);break;case"g":this.tabClear(this.params);break;case"p":switch(this.prefix){case"!":this.softReset(this.params)}break;default:this.error("Unknown CSI code: %s.",i)}this.prefix="",this.postfix="";break;case g:if(""===i||""===i){switch(""===i&&a++,this.prefix){case"":break;case"$q":var c=this.currentParam,u=!1;switch(c){case'"q':c='0"q';break;case'"p':c='61"p';break;case"r":c=""+(this.scrollTop+1)+";"+(this.scrollBottom+1)+"r";break;case"m":c="0m";break;default:this.error("Unknown DCS Pt: %s.",c),c=""}this.send("P"+ +u+"$r"+c+"\\");break;case"+p":break;case"+q":var c=this.currentParam,u=!1;this.send("P"+ +u+"+r"+c+"\\");break;default:this.error("Unknown DCS prefix: %s.",this.prefix)}this.currentParam=0,this.prefix="",this.state=p}else this.currentParam?this.currentParam+=i:this.prefix||"$"===i||"+"===i?2===this.prefix.length?this.currentParam=i:this.prefix+=i:this.currentParam=i;break;case b:(""===i||""===i)&&(""===i&&a++,this.state=p)}this.updateRange(this.y),this.refresh(this.refreshStart,this.refreshEnd)},Terminal.prototype.writeln=function(t){this.write(t+"\r\n")},Terminal.prototype.keyDown=function(t){var e,s=this;switch(t.keyCode){case 8:if(t.shiftKey){e="\b";break}e="";break;case 9:if(t.shiftKey){e="[Z";break}e="	";break;case 13:e="\r";break;case 27:e="";break;case 37:if(this.applicationCursor){e="OD";break}e="[D";break;case 39:if(this.applicationCursor){e="OC";break}e="[C";break;case 38:if(this.applicationCursor){e="OA";break}if(t.ctrlKey)return this.scrollDisp(-1),i(t);e="[A";break;case 40:if(this.applicationCursor){e="OB";break}if(t.ctrlKey)return this.scrollDisp(1),i(t);e="[B";break;case 46:e="[3~";break;case 45:e="[2~";break;case 36:if(this.applicationKeypad){e="OH";break}e="OH";break;case 35:if(this.applicationKeypad){e="OF";break}e="OF";break;case 33:if(t.shiftKey)return this.scrollDisp(-(this.rows-1)),i(t);e="[5~";break;case 34:if(t.shiftKey)return this.scrollDisp(this.rows-1),i(t);e="[6~";break;case 112:e="OP";break;case 113:e="OQ";break;case 114:e="OR";break;case 115:e="OS";break;case 116:e="[15~";break;case 117:e="[17~";break;case 118:e="[18~";break;case 119:e="[19~";break;case 120:e="[20~";break;case 121:e="[21~";break;case 122:e="[23~";break;case 123:e="[24~";break;default:if(t.ctrlKey)if(t.keyCode>=65&&t.keyCode<=90){if(this.screenKeys&&!this.prefixMode&&!this.selectMode&&65===t.keyCode)return this.enterPrefix(),i(t);if(this.prefixMode&&86===t.keyCode)return this.leavePrefix(),void 0;if((this.prefixMode||this.selectMode)&&67===t.keyCode)return this.visualMode&&T(function(){s.leaveVisual()},1),void 0;e=v.fromCharCode(t.keyCode-64)}else 32===t.keyCode?e=v.fromCharCode(0):t.keyCode>=51&&t.keyCode<=55?e=v.fromCharCode(t.keyCode-51+27):56===t.keyCode?e=v.fromCharCode(127):219===t.keyCode?e=v.fromCharCode(27):221===t.keyCode&&(e=v.fromCharCode(29));else(!this.isMac&&t.altKey||this.isMac&&t.metaKey)&&(t.keyCode>=65&&t.keyCode<=90?e=""+v.fromCharCode(t.keyCode+32):192===t.keyCode?e="`":t.keyCode>=48&&t.keyCode<=57&&(e=""+(t.keyCode-48)))}return e?this.prefixMode?(this.leavePrefix(),i(t)):this.selectMode?(this.keySelect(t,e),i(t)):(this.emit("keydown",t),this.emit("key",e,t),this.showCursor(),this.handler(e),i(t)):!0},Terminal.prototype.setgLevel=function(t){this.glevel=t,this.charset=this.charsets[t]},Terminal.prototype.setgCharset=function(t,e){this.charsets[t]=e,this.glevel===t&&(this.charset=e)},Terminal.prototype.keyPress=function(t){var e;if(i(t),t.charCode)e=t.charCode;else if(null==t.which)e=t.keyCode;else{if(0===t.which||0===t.charCode)return!1;e=t.which}return!e||t.ctrlKey||t.altKey||t.metaKey?!1:(e=v.fromCharCode(e),this.prefixMode?(this.leavePrefix(),this.keyPrefix(t,e),!1):this.selectMode?(this.keySelect(t,e),!1):(this.emit("keypress",e,t),this.emit("key",e,t),this.showCursor(),this.handler(e),!1))},Terminal.prototype.send=function(t){var e=this;this.queue||T(function(){e.handler(e.queue),e.queue=""},1),this.queue+=t},Terminal.prototype.bell=function(){if(this.visualBell){var t=this;this.element.style.borderColor="white",T(function(){t.element.style.borderColor=""},10),this.popOnBell&&this.focus()}},Terminal.prototype.log=function(){if(this.debug&&this.context.console&&this.context.console.log){var t=Array.prototype.slice.call(arguments);this.context.console.log.apply(this.context.console,t)}},Terminal.prototype.error=function(){if(this.debug&&this.context.console&&this.context.console.error){var t=Array.prototype.slice.call(arguments);this.context.console.error.apply(this.context.console,t)}},Terminal.prototype.resize=function(t,e){var s,i,r,a,n;if(1>t&&(t=1),1>e&&(e=1),a=this.cols,t>a)for(n=[this.defAttr," "],r=this.lines.length;r--;)for(;this.lines[r].length<t;)this.lines[r].push(n);else if(a>t)for(r=this.lines.length;r--;)for(;this.lines[r].length>t;)this.lines[r].pop();if(this.setupStops(a),this.cols=t,a=this.rows,e>a)for(i=this.element;a++<e;)this.lines.length<e+this.ybase&&this.lines.push(this.blankLine()),this.children.length<e&&(s=this.document.createElement("div"),i.appendChild(s),this.children.push(s));else if(a>e)for(;a-->e;)if(this.lines.length>e+this.ybase&&this.lines.pop(),this.children.length>e){if(i=this.children.pop(),!i)continue;i.parentNode.removeChild(i)}this.rows=e,this.y>=e&&(this.y=e-1),this.x>=t&&(this.x=t-1),this.scrollTop=0,this.scrollBottom=e-1,this.refresh(0,this.rows-1),this.normal=null},Terminal.prototype.updateRange=function(t){t<this.refreshStart&&(this.refreshStart=t),t>this.refreshEnd&&(this.refreshEnd=t)},Terminal.prototype.maxRange=function(){this.refreshStart=0,this.refreshEnd=this.rows-1},Terminal.prototype.setupStops=function(t){for(null!=t?this.tabs[t]||(t=this.prevStop(t)):(this.tabs={},t=0);t<this.cols;t+=8)this.tabs[t]=!0},Terminal.prototype.prevStop=function(t){for(null==t&&(t=this.x);!this.tabs[--t]&&t>0;);return t>=this.cols?this.cols-1:0>t?0:t},Terminal.prototype.nextStop=function(t){for(null==t&&(t=this.x);!this.tabs[++t]&&t<this.cols;);return t>=this.cols?this.cols-1:0>t?0:t},Terminal.prototype.eraseRight=function(t,e){for(var s=this.lines[this.ybase+e],i=[this.eraseAttr()," "];t<this.cols;t++)s[t]=i;this.updateRange(e)},Terminal.prototype.eraseLeft=function(t,e){var s=this.lines[this.ybase+e],i=[this.eraseAttr()," "];for(t++;t--;)s[t]=i;this.updateRange(e)},Terminal.prototype.eraseLine=function(t){this.eraseRight(0,t)},Terminal.prototype.blankLine=function(t){for(var e=t?this.eraseAttr():this.defAttr,s=[e," "],i=[],r=0;r<this.cols;r++)i[r]=s;return i},Terminal.prototype.ch=function(t){return t?[this.eraseAttr()," "]:[this.defAttr," "]},Terminal.prototype.is=function(t){var e=this.termName;return 0===(e+"").indexOf(t)},Terminal.prototype.handler=function(t){this.emit("data",t)},Terminal.prototype.handleTitle=function(t){this.emit("title",t)},Terminal.prototype.index=function(){this.y++,this.y>this.scrollBottom&&(this.y--,this.scroll()),this.state=p},Terminal.prototype.reverseIndex=function(){var t;this.y--,this.y<this.scrollTop&&(this.y++,this.lines.splice(this.y+this.ybase,0,this.blankLine(!0)),t=this.rows-1-this.scrollBottom,this.lines.splice(this.rows-1+this.ybase-t+1,1),this.updateRange(this.scrollTop),this.updateRange(this.scrollBottom)),this.state=p},Terminal.prototype.reset=function(){Terminal.call(this,this.options),this.refresh(0,this.rows-1)},Terminal.prototype.tabSet=function(){this.tabs[this.x]=!0,this.state=p},Terminal.prototype.cursorUp=function(t){var e=t[0];1>e&&(e=1),this.y-=e,this.y<0&&(this.y=0)},Terminal.prototype.cursorDown=function(t){var e=t[0];1>e&&(e=1),this.y+=e,this.y>=this.rows&&(this.y=this.rows-1)},Terminal.prototype.cursorForward=function(t){var e=t[0];1>e&&(e=1),this.x+=e,this.x>=this.cols&&(this.x=this.cols-1)},Terminal.prototype.cursorBackward=function(t){var e=t[0];1>e&&(e=1),this.x-=e,this.x<0&&(this.x=0)},Terminal.prototype.cursorPos=function(t){var e,s;e=t[0]-1,s=t.length>=2?t[1]-1:0,0>e?e=0:e>=this.rows&&(e=this.rows-1),0>s?s=0:s>=this.cols&&(s=this.cols-1),this.x=s,this.y=e},Terminal.prototype.eraseInDisplay=function(t){var e;switch(t[0]){case 0:for(this.eraseRight(this.x,this.y),e=this.y+1;e<this.rows;e++)this.eraseLine(e);break;case 1:for(this.eraseLeft(this.x,this.y),e=this.y;e--;)this.eraseLine(e);break;case 2:for(e=this.rows;e--;)this.eraseLine(e);break;case 3:}},Terminal.prototype.eraseInLine=function(t){switch(t[0]){case 0:this.eraseRight(this.x,this.y);break;case 1:this.eraseLeft(this.x,this.y);break;case 2:this.eraseLine(this.y)}},Terminal.prototype.charAttributes=function(t){if(1===t.length&&0===t[0])return this.curAttr=this.defAttr,void 0;for(var e,s=t.length,i=0,r=this.curAttr>>18,a=511&this.curAttr>>9,n=511&this.curAttr;s>i;i++)e=t[i],e>=30&&37>=e?a=e-30:e>=40&&47>=e?n=e-40:e>=90&&97>=e?(e+=8,a=e-90):e>=100&&107>=e?(e+=8,n=e-100):0===e?(r=this.defAttr>>18,a=511&this.defAttr>>9,n=511&this.defAttr):1===e?r|=1:4===e?r|=2:5===e?r|=4:7===e?r|=8:8===e?r|=16:22===e?r&=-2:24===e?r&=-3:25===e?r&=-5:27===e?r&=-9:28===e?r&=-17:39===e?a=511&this.defAttr>>9:49===e?n=511&this.defAttr:38===e?2===t[i+1]?(i+=2,a=h(255&t[i],255&t[i+1],255&t[i+2]),-1===a&&(a=511),i+=2):5===t[i+1]&&(i+=2,e=255&t[i],a=e):48===e?2===t[i+1]?(i+=2,n=h(255&t[i],255&t[i+1],255&t[i+2]),-1===n&&(n=511),i+=2):5===t[i+1]&&(i+=2,e=255&t[i],n=e):100===e?(a=511&this.defAttr>>9,n=511&this.defAttr):this.error("Unknown SGR attribute: %d.",e);this.curAttr=r<<18|a<<9|n},Terminal.prototype.deviceStatus=function(t){if(this.prefix){if("?"===this.prefix)switch(t[0]){case 6:this.send("[?"+(this.y+1)+";"+(this.x+1)+"R");break;case 15:break;case 25:break;case 26:break;case 53:}}else switch(t[0]){case 5:this.send("[0n");break;case 6:this.send("["+(this.y+1)+";"+(this.x+1)+"R")}},Terminal.prototype.insertChars=function(t){var e,s,i,r;for(e=t[0],1>e&&(e=1),s=this.y+this.ybase,i=this.x,r=[this.eraseAttr()," "];e--&&i<this.cols;)this.lines[s].splice(i++,0,r),this.lines[s].pop()},Terminal.prototype.cursorNextLine=function(t){var e=t[0];1>e&&(e=1),this.y+=e,this.y>=this.rows&&(this.y=this.rows-1),this.x=0},Terminal.prototype.cursorPrecedingLine=function(t){var e=t[0];1>e&&(e=1),this.y-=e,this.y<0&&(this.y=0),this.x=0},Terminal.prototype.cursorCharAbsolute=function(t){var e=t[0];1>e&&(e=1),this.x=e-1},Terminal.prototype.insertLines=function(t){var e,s,i;for(e=t[0],1>e&&(e=1),s=this.y+this.ybase,i=this.rows-1-this.scrollBottom,i=this.rows-1+this.ybase-i+1;e--;)this.lines.splice(s,0,this.blankLine(!0)),this.lines.splice(i,1);this.updateRange(this.y),this.updateRange(this.scrollBottom)},Terminal.prototype.deleteLines=function(t){var e,s,i;for(e=t[0],1>e&&(e=1),s=this.y+this.ybase,i=this.rows-1-this.scrollBottom,i=this.rows-1+this.ybase-i;e--;)this.lines.splice(i+1,0,this.blankLine(!0)),this.lines.splice(s,1);this.updateRange(this.y),this.updateRange(this.scrollBottom)},Terminal.prototype.deleteChars=function(t){var e,s,i;for(e=t[0],1>e&&(e=1),s=this.y+this.ybase,i=[this.eraseAttr()," "];e--;)this.lines[s].splice(this.x,1),this.lines[s].push(i)},Terminal.prototype.eraseChars=function(t){var e,s,i,r;for(e=t[0],1>e&&(e=1),s=this.y+this.ybase,i=this.x,r=[this.eraseAttr()," "];e--&&i<this.cols;)this.lines[s][i++]=r},Terminal.prototype.charPosAbsolute=function(t){var e=t[0];1>e&&(e=1),this.x=e-1,this.x>=this.cols&&(this.x=this.cols-1)},Terminal.prototype.HPositionRelative=function(t){var e=t[0];1>e&&(e=1),this.x+=e,this.x>=this.cols&&(this.x=this.cols-1)},Terminal.prototype.sendDeviceAttributes=function(t){t[0]>0||(this.prefix?">"===this.prefix&&(this.is("xterm")?this.send("[>0;276;0c"):this.is("rxvt-unicode")?this.send("[>85;95;0c"):this.is("linux")?this.send(t[0]+"c"):this.is("screen")&&this.send("[>83;40003;0c")):this.is("xterm")||this.is("rxvt-unicode")||this.is("screen")?this.send("[?1;2c"):this.is("linux")&&this.send("[?6c"))},Terminal.prototype.linePosAbsolute=function(t){var e=t[0];1>e&&(e=1),this.y=e-1,this.y>=this.rows&&(this.y=this.rows-1)},Terminal.prototype.VPositionRelative=function(t){var e=t[0];1>e&&(e=1),this.y+=e,this.y>=this.rows&&(this.y=this.rows-1)},Terminal.prototype.HVPosition=function(t){t[0]<1&&(t[0]=1),t[1]<1&&(t[1]=1),this.y=t[0]-1,this.y>=this.rows&&(this.y=this.rows-1),this.x=t[1]-1,this.x>=this.cols&&(this.x=this.cols-1)},Terminal.prototype.setMode=function(t){if("object"!=typeof t)if(this.prefix){if("?"===this.prefix)switch(t){case 1:this.applicationCursor=!0;break;case 2:this.setgCharset(0,Terminal.charsets.US),this.setgCharset(1,Terminal.charsets.US),this.setgCharset(2,Terminal.charsets.US),this.setgCharset(3,Terminal.charsets.US);break;case 3:this.savedCols=this.cols,this.resize(132,this.rows);break;case 6:this.originMode=!0;break;case 7:this.wraparoundMode=!0;break;case 12:break;case 66:this.log("Serial port requested application keypad."),this.applicationKeypad=!0;break;case 9:case 1e3:case 1002:case 1003:this.x10Mouse=9===t,this.vt200Mouse=1e3===t,this.normalMouse=t>1e3,this.mouseEvents=!0,this.element.style.cursor="default",this.log("Binding to mouse events.");break;case 1004:this.sendFocus=!0;break;case 1005:this.utfMouse=!0;break;case 1006:this.sgrMouse=!0;break;case 1015:this.urxvtMouse=!0;break;case 25:this.cursorHidden=!1;break;case 1049:case 47:case 1047:if(!this.normal){var e={lines:this.lines,ybase:this.ybase,ydisp:this.ydisp,x:this.x,y:this.y,scrollTop:this.scrollTop,scrollBottom:this.scrollBottom,tabs:this.tabs};this.reset(),this.normal=e,this.showCursor()}}}else switch(t){case 4:this.insertMode=!0;break;case 20:}else for(var s=t.length,i=0;s>i;i++)this.setMode(t[i])},Terminal.prototype.resetMode=function(t){if("object"!=typeof t)if(this.prefix){if("?"===this.prefix)switch(t){case 1:this.applicationCursor=!1;break;case 3:132===this.cols&&this.savedCols&&this.resize(this.savedCols,this.rows),delete this.savedCols;break;case 6:this.originMode=!1;break;case 7:this.wraparoundMode=!1;break;case 12:break;case 66:this.log("Switching back to normal keypad."),this.applicationKeypad=!1;break;case 9:case 1e3:case 1002:case 1003:this.x10Mouse=!1,this.vt200Mouse=!1,this.normalMouse=!1,this.mouseEvents=!1,this.element.style.cursor="";break;case 1004:this.sendFocus=!1;break;case 1005:this.utfMouse=!1;break;case 1006:this.sgrMouse=!1;break;case 1015:this.urxvtMouse=!1;break;case 25:this.cursorHidden=!0;break;case 1049:case 47:case 1047:this.normal&&(this.lines=this.normal.lines,this.ybase=this.normal.ybase,this.ydisp=this.normal.ydisp,this.x=this.normal.x,this.y=this.normal.y,this.scrollTop=this.normal.scrollTop,this.scrollBottom=this.normal.scrollBottom,this.tabs=this.normal.tabs,this.normal=null,this.refresh(0,this.rows-1),this.showCursor())}}else switch(t){case 4:this.insertMode=!1;break;case 20:}else for(var e=t.length,s=0;e>s;s++)this.resetMode(t[s])},Terminal.prototype.setScrollRegion=function(t){this.prefix||(this.scrollTop=(t[0]||1)-1,this.scrollBottom=(t[1]||this.rows)-1,this.x=0,this.y=0)},Terminal.prototype.saveCursor=function(){this.savedX=this.x,this.savedY=this.y},Terminal.prototype.restoreCursor=function(){this.x=this.savedX||0,this.y=this.savedY||0},Terminal.prototype.cursorForwardTab=function(t){for(var e=t[0]||1;e--;)this.x=this.nextStop()},Terminal.prototype.scrollUp=function(t){for(var e=t[0]||1;e--;)this.lines.splice(this.ybase+this.scrollTop,1),this.lines.splice(this.ybase+this.scrollBottom,0,this.blankLine());this.updateRange(this.scrollTop),this.updateRange(this.scrollBottom)},Terminal.prototype.scrollDown=function(t){for(var e=t[0]||1;e--;)this.lines.splice(this.ybase+this.scrollBottom,1),this.lines.splice(this.ybase+this.scrollTop,0,this.blankLine());this.updateRange(this.scrollTop),this.updateRange(this.scrollBottom)},Terminal.prototype.initMouseTracking=function(){},Terminal.prototype.resetTitleModes=function(){},Terminal.prototype.cursorBackwardTab=function(t){for(var e=t[0]||1;e--;)this.x=this.prevStop()},Terminal.prototype.repeatPrecedingCharacter=function(t){for(var e=t[0]||1,s=this.lines[this.ybase+this.y],i=s[this.x-1]||[this.defAttr," "];e--;)s[this.x++]=i},Terminal.prototype.tabClear=function(t){var e=t[0];0>=e?delete this.tabs[this.x]:3===e&&(this.tabs={})},Terminal.prototype.mediaCopy=function(){},Terminal.prototype.setResources=function(){},Terminal.prototype.disableModifiers=function(){},Terminal.prototype.setPointerMode=function(){},Terminal.prototype.softReset=function(){this.cursorHidden=!1,this.insertMode=!1,this.originMode=!1,this.wraparoundMode=!1,this.applicationKeypad=!1,this.applicationCursor=!1,this.scrollTop=0,this.scrollBottom=this.rows-1,this.curAttr=this.defAttr,this.x=this.y=0,this.charset=null,this.glevel=0,this.charsets=[null]},Terminal.prototype.requestAnsiMode=function(){},Terminal.prototype.requestPrivateMode=function(){},Terminal.prototype.setConformanceLevel=function(){},Terminal.prototype.loadLEDs=function(){},Terminal.prototype.setCursorStyle=function(){},Terminal.prototype.setCharProtectionAttr=function(){},Terminal.prototype.restorePrivateValues=function(){},Terminal.prototype.setAttrInRectangle=function(t){for(var e,s,i=t[0],r=t[1],a=t[2],n=t[3],o=t[4];a+1>i;i++)for(e=this.lines[this.ybase+i],s=r;n>s;s++)e[s]=[o,e[s][1]];this.updateRange(t[0]),this.updateRange(t[2])},Terminal.prototype.savePrivateValues=function(){},Terminal.prototype.manipulateWindow=function(){},Terminal.prototype.reverseAttrInRectangle=function(){},Terminal.prototype.setTitleModeFeature=function(){},Terminal.prototype.setWarningBellVolume=function(){},Terminal.prototype.setMarginBellVolume=function(){},Terminal.prototype.copyRectangle=function(){},Terminal.prototype.enableFilterRectangle=function(){},Terminal.prototype.requestParameters=function(){},Terminal.prototype.selectChangeExtent=function(){},Terminal.prototype.fillRectangle=function(t){for(var e,s,i=t[0],r=t[1],a=t[2],n=t[3],o=t[4];n+1>r;r++)for(e=this.lines[this.ybase+r],s=a;o>s;s++)e[s]=[e[s][0],v.fromCharCode(i)];this.updateRange(t[1]),this.updateRange(t[3])},Terminal.prototype.enableLocatorReporting=function(t){t[0]>0},Terminal.prototype.eraseRectangle=function(t){var e,s,i,r=t[0],a=t[1],n=t[2],o=t[3];for(i=[this.eraseAttr()," "];n+1>r;r++)for(e=this.lines[this.ybase+r],s=a;o>s;s++)e[s]=i;this.updateRange(t[0]),this.updateRange(t[2])},Terminal.prototype.setLocatorEvents=function(){},Terminal.prototype.selectiveEraseRectangle=function(){},Terminal.prototype.requestLocatorPosition=function(){},Terminal.prototype.insertColumns=function(){for(var t,e=params[0],s=this.ybase+this.rows,i=[this.eraseAttr()," "];e--;)for(t=this.ybase;s>t;t++)this.lines[t].splice(this.x+1,0,i),this.lines[t].pop();this.maxRange()},Terminal.prototype.deleteColumns=function(){for(var t,e=params[0],s=this.ybase+this.rows,i=[this.eraseAttr()," "];e--;)for(t=this.ybase;s>t;t++)this.lines[t].splice(this.x,1),this.lines[t].push(i);this.maxRange()},Terminal.prototype.enterPrefix=function(){this.prefixMode=!0},Terminal.prototype.leavePrefix=function(){this.prefixMode=!1},Terminal.prototype.enterSelect=function(){this._real={x:this.x,y:this.y,ydisp:this.ydisp,ybase:this.ybase,cursorHidden:this.cursorHidden,lines:this.copyBuffer(this.lines),write:this.write},this.write=function(){},this.selectMode=!0,this.visualMode=!1,this.cursorHidden=!1,this.refresh(this.y,this.y)},Terminal.prototype.leaveSelect=function(){this.x=this._real.x,this.y=this._real.y,this.ydisp=this._real.ydisp,this.ybase=this._real.ybase,this.cursorHidden=this._real.cursorHidden,this.lines=this._real.lines,this.write=this._real.write,delete this._real,this.selectMode=!1,this.visualMode=!1,this.refresh(0,this.rows-1)},Terminal.prototype.enterVisual=function(){this._real.preVisual=this.copyBuffer(this.lines),this.selectText(this.x,this.x,this.ydisp+this.y,this.ydisp+this.y),this.visualMode=!0},Terminal.prototype.leaveVisual=function(){this.lines=this._real.preVisual,delete this._real.preVisual,delete this._selected,this.visualMode=!1,this.refresh(0,this.rows-1)},Terminal.prototype.enterSearch=function(t){this.entry="",this.searchMode=!0,this.searchDown=t,this._real.preSearch=this.copyBuffer(this.lines),this._real.preSearchX=this.x,this._real.preSearchY=this.y,this.entryPrefix="Search: ";for(var e=this.ydisp+this.rows-1,s=0;s<this.entryPrefix.length;s++)this.lines[e][s]=[4|-512&this.defAttr,this.entryPrefix[s]];this.y=this.rows-1,this.x=this.entryPrefix.length,this.refresh(this.rows-1,this.rows-1)},Terminal.prototype.leaveSearch=function(){this.searchMode=!1,this._real.preSearch&&(this.lines=this._real.preSearch,this.x=this._real.preSearchX,this.y=this._real.preSearchY,delete this._real.preSearch,delete this._real.preSearchX,delete this._real.preSearchY),this.refresh(this.rows-1,this.rows-1)},Terminal.prototype.copyBuffer=function(t){for(var t=t||this.lines,e=[],s=0;s<t.length;s++){e[s]=[];for(var i=0;i<t[s].length;i++)e[s][i]=[t[s][i][0],t[s][i][1]]}return e},Terminal.prototype.getCopyTextarea=function(){var t=this._copyTextarea,e=this.document;return t||(t=e.createElement("textarea"),t.style.position="absolute",t.style.left="-32000px",t.style.top="-32000px",t.style.width="0px",t.style.height="0px",t.style.opacity="0",t.style.backgroundColor="transparent",t.style.borderStyle="none",t.style.outlineStyle="none",e.getElementsByTagName("body")[0].appendChild(t),this._copyTextarea=t),t},Terminal.prototype.copyText=function(t){var e=this,s=this.getCopyTextarea();this.emit("copy",t),s.focus(),s.textContent=t,s.value=t,s.setSelectionRange(0,t.length),T(function(){e.element.focus(),e.focus()},1)},Terminal.prototype.selectText=function(t,e,s,i){var r,a,n,o,h,l,c,u,p;if(this._selected){for(r=this._selected.x1,a=this._selected.x2,n=this._selected.y1,o=this._selected.y2,n>o&&(h=a,a=r,r=h,h=o,o=n,n=h),r>a&&n===o&&(h=a,a=r,r=h),c=n;o>=c;c++)for(l=0,u=this.cols-1,c===n&&(l=r),c===o&&(u=a);u>=l;l++)null!=this.lines[c][l].old&&(p=this.lines[c][l].old,delete this.lines[c][l].old,this.lines[c][l]=[p,this.lines[c][l][1]]);s=this._selected.y1,t=this._selected.x1}for(s=Math.max(s,0),s=Math.min(s,this.ydisp+this.rows-1),i=Math.max(i,0),i=Math.min(i,this.ydisp+this.rows-1),this._selected={x1:t,x2:e,y1:s,y2:i},s>i&&(h=e,e=t,t=h,h=i,i=s,s=h),t>e&&s===i&&(h=e,e=t,t=h),c=s;i>=c;c++)for(l=0,u=this.cols-1,c===s&&(l=t),c===i&&(u=e);u>=l;l++)p=this.lines[c][l][0],this.lines[c][l]=[261636|-512&p,this.lines[c][l][1]],this.lines[c][l].old=p;s-=this.ydisp,i-=this.ydisp,s=Math.max(s,0),s=Math.min(s,this.rows-1),i=Math.max(i,0),i=Math.min(i,this.rows-1),this.refresh(0,this.rows-1)
},Terminal.prototype.grabText=function(t,e,s,i){var r,a,n,h,l,c="",u="";for(s>i&&(l=e,e=t,t=l,l=i,i=s,s=l),t>e&&s===i&&(l=e,e=t,t=l),n=s;i>=n;n++){for(a=0,h=this.cols-1,n===s&&(a=t),n===i&&(h=e);h>=a;a++)r=this.lines[n][a][1]," "!==r?(u&&(c+=u,u=""),c+=r,o(r)&&a++):u+=r;u="",c+="\n"}for(a=e,n=i;a<this.cols;a++)if(" "!==this.lines[n][a][1]){c=c.slice(0,-1);break}return c},Terminal.prototype.keyPrefix=function(t,e){"k"===e||"&"===e?this.destroy():"p"===e||"]"===e?this.emit("request paste"):"c"===e?this.emit("request create"):e>="0"&&"9">=e?(e=+e-1,~e||(e=9),this.emit("request term",e)):"n"===e?this.emit("request term next"):"P"===e?this.emit("request term previous"):":"===e?this.emit("request command mode"):"["===e&&this.enterSelect()},Terminal.prototype.keySelect=function(t,e){if(this.showCursor(),this.searchMode||"n"===e||"N"===e)return this.keySearch(t,e);if(""===e){var s=this.ydisp+this.y;return this.ydisp===this.ybase?(this.y=Math.min(0|this.y+(this.rows-1)/2,this.rows-1),this.refresh(0,this.rows-1)):this.scrollDisp(0|(this.rows-1)/2),this.visualMode&&this.selectText(this.x,this.x,s,this.ydisp+this.y),void 0}if(""===e){var s=this.ydisp+this.y;return 0===this.ydisp?(this.y=Math.max(0|this.y-(this.rows-1)/2,0),this.refresh(0,this.rows-1)):this.scrollDisp(0|-(this.rows-1)/2),this.visualMode&&this.selectText(this.x,this.x,s,this.ydisp+this.y),void 0}if(""===e){var s=this.ydisp+this.y;return this.scrollDisp(this.rows-1),this.visualMode&&this.selectText(this.x,this.x,s,this.ydisp+this.y),void 0}if(""===e){var s=this.ydisp+this.y;return this.scrollDisp(-(this.rows-1)),this.visualMode&&this.selectText(this.x,this.x,s,this.ydisp+this.y),void 0}if("k"===e){var s=this.ydisp+this.y;return this.y--,this.y<0&&(this.y=0,this.scrollDisp(-1)),this.visualMode?this.selectText(this.x,this.x,s,this.ydisp+this.y):this.refresh(this.y,this.y+1),void 0}if("j"===e){var s=this.ydisp+this.y;return this.y++,this.y>=this.rows&&(this.y=this.rows-1,this.scrollDisp(1)),this.visualMode?this.selectText(this.x,this.x,s,this.ydisp+this.y):this.refresh(this.y-1,this.y),void 0}if("h"===e){var i=this.x;return this.x--,this.x<0&&(this.x=0),this.visualMode?this.selectText(this.x,i,this.ydisp+this.y,this.ydisp+this.y):this.refresh(this.y,this.y),void 0}if("l"===e){var i=this.x;return this.x++,this.x>=this.cols&&(this.x=this.cols-1),this.visualMode?this.selectText(i,this.x,this.ydisp+this.y,this.ydisp+this.y):this.refresh(this.y,this.y),void 0}if("v"===e||" "===e)return this.visualMode?this.leaveVisual():this.enterVisual(),void 0;if("y"!==e){if("q"===e)return this.visualMode?this.leaveVisual():this.leaveSelect(),void 0;if("w"===e||"W"===e){for(var r=this.x,a=this.y,n=this.ydisp,i=this.x,s=this.y,o=this.ydisp,h=!1;;){for(var l=this.lines[o+s];i<this.cols;){if(l[i][1]<=" ")h=!0;else if(h)break;i++}if(i>=this.cols&&(i=this.cols-1),!(i===this.cols-1&&l[i][1]<=" "))break;if(i=0,++s>=this.rows&&(s--,++o>this.ybase)){o=this.ybase,i=this.x;break}}return this.x=i,this.y=s,this.scrollDisp(-this.ydisp+o),this.visualMode&&this.selectText(r,this.x,a+n,this.ydisp+this.y),void 0}if("b"===e||"B"===e){for(var r=this.x,a=this.y,n=this.ydisp,i=this.x,s=this.y,o=this.ydisp;;){for(var l=this.lines[o+s],h=i>0&&l[i][1]>" "&&l[i-1][1]>" ";i>=0;){if(l[i][1]<=" "){if(h&&i+1<this.cols&&l[i+1][1]>" "){i++;break}h=!0}i--}if(0>i&&(i=0),0!==i||!(l[i][1]<=" ")&&h)break;if(i=this.cols-1,--s<0&&(s++,--o<0)){o++,i=0;break}}return this.x=i,this.y=s,this.scrollDisp(-this.ydisp+o),this.visualMode&&this.selectText(this.x,r,this.ydisp+this.y,a+n),void 0}if("e"===e||"E"===e){var i=this.x+1,s=this.y,o=this.ydisp;for(i>=this.cols&&i--;;){for(var l=this.lines[o+s];i<this.cols&&l[i][1]<=" ";)i++;for(;i<this.cols;){if(l[i][1]<=" "&&i-1>=0&&l[i-1][1]>" "){i--;break}i++}if(i>=this.cols&&(i=this.cols-1),!(i===this.cols-1&&l[i][1]<=" "))break;if(i=0,++s>=this.rows&&(s--,++o>this.ybase)){o=this.ybase;break}}return this.x=i,this.y=s,this.scrollDisp(-this.ydisp+o),this.visualMode&&this.selectText(r,this.x,a+n,this.ydisp+this.y),void 0}if("^"===e||"0"===e){var r=this.x;if("0"===e)this.x=0;else if("^"===e){for(var l=this.lines[this.ydisp+this.y],i=0;i<this.cols&&!(l[i][1]>" ");)i++;i>=this.cols&&(i=this.cols-1),this.x=i}return this.visualMode?this.selectText(this.x,r,this.ydisp+this.y,this.ydisp+this.y):this.refresh(this.y,this.y),void 0}if("$"===e){for(var r=this.x,l=this.lines[this.ydisp+this.y],i=this.cols-1;i>=0;){if(l[i][1]>" "){this.visualMode&&i<this.cols-1&&i++;break}i--}return 0>i&&(i=0),this.x=i,this.visualMode?this.selectText(r,this.x,this.ydisp+this.y,this.ydisp+this.y):this.refresh(this.y,this.y),void 0}if("g"===e||"G"===e){var r=this.x,a=this.y,n=this.ydisp;return"g"===e?(this.x=0,this.y=0,this.scrollDisp(-this.ydisp)):"G"===e&&(this.x=0,this.y=this.rows-1,this.scrollDisp(this.ybase)),this.visualMode&&this.selectText(r,this.x,a+n,this.ydisp+this.y),void 0}if("H"===e||"M"===e||"L"===e){var r=this.x,a=this.y;return"H"===e?(this.x=0,this.y=0):"M"===e?(this.x=0,this.y=0|this.rows/2):"L"===e&&(this.x=0,this.y=this.rows-1),this.visualMode?this.selectText(r,this.x,this.ydisp+a,this.ydisp+this.y):(this.refresh(a,a),this.refresh(this.y,this.y)),void 0}if("{"===e||"}"===e){var l,c,r=this.x,a=this.y,n=this.ydisp,u=!1,p=!1,d=-1,s=this.y+("{"===e?-1:1),o=this.ydisp;for("{"===e?0>s&&(s++,o>0&&o--):"}"===e&&s>=this.rows&&(s--,o<this.ybase&&o++);;){for(l=this.lines[o+s],c=0;c<this.cols;c++){if(l[c][1]>" "){-1===d&&(d=0),u=!0;break}if(c===this.cols-1){-1===d?d=1:0===d?p=!0:1===d&&u&&(p=!0);break}}if(p)break;if("{"===e){if(s--,0>s){if(s++,!(o>0))break;o--}}else if("}"===e&&(s++,s>=this.rows)){if(s--,!(o<this.ybase))break;o++}}return p||("{"===e?(s=0,o=0):"}"===e&&(s=this.rows-1,o=this.ybase)),this.x=0,this.y=s,this.scrollDisp(-this.ydisp+o),this.visualMode&&this.selectText(r,this.x,a+n,this.ydisp+this.y),void 0}return"/"===e||"?"===e?(this.visualMode||this.enterSearch("/"===e),void 0):!1}if(this.visualMode){var f=this.grabText(this._selected.x1,this._selected.x2,this._selected.y1,this._selected.y2);this.copyText(f),this.leaveVisual()}},Terminal.prototype.keySearch=function(t,e){if(""===e)return this.leaveSearch(),void 0;if("\r"===e||!this.searchMode&&("n"===e||"N"===e)){this.leaveSearch();var s=this.entry;if(!s)return this.refresh(0,this.rows-1),void 0;for(var i,r,a,n=this.x,o=this.y,h=this.ydisp,l=!1,c=!1,u=this.x+1,p=this.ydisp+this.y,d="N"===e?this.searchDown:!this.searchDown;;){for(i=this.lines[p];u<this.cols;){for(a=0;a<s.length&&!(u+a>=this.cols)&&i[u+a][1]===s[a];a++)if(i[u+a][1]===s[a]&&a===s.length-1){l=!0;break}if(l)break;u+=a+1}if(l)break;if(u=0,d){if(p--,0>p){if(c)break;c=!0,p=this.ybase+this.rows-1}}else if(p++,p>this.ybase+this.rows-1){if(c)break;c=!0,p=0}}return l?(p-this.ybase<0?(r=p,p=0,r>this.ybase&&(p=r-this.ybase,r=this.ybase)):(r=this.ybase,p-=this.ybase),this.x=u,this.y=p,this.scrollDisp(-this.ydisp+r),this.visualMode&&this.selectText(n,this.x,o+h,this.ydisp+this.y),void 0):(this.refresh(0,this.rows-1),void 0)}if("\b"===e||""===e){if(0===this.entry.length)return;var f=this.ydisp+this.rows-1;this.entry=this.entry.slice(0,-1);var a=this.entryPrefix.length+this.entry.length;return this.lines[f][a]=[this.lines[f][a][0]," "],this.x--,this.refresh(this.rows-1,this.rows-1),this.refresh(this.y,this.y),void 0}if(1===e.length&&e>=" "&&"~">=e){var f=this.ydisp+this.rows-1;this.entry+=e;var a=this.entryPrefix.length+this.entry.length-1;return this.lines[f][a]=[4|-512&this.defAttr,e],this.x++,this.refresh(this.rows-1,this.rows-1),this.refresh(this.y,this.y),void 0}return!1},Terminal.charsets={},Terminal.charsets.SCLD={"`":"‚óÜ",a:"‚ñí",b:"	",c:"\f",d:"\r",e:"\n",f:"¬∞",g:"¬±",h:"‚ê§",i:"",j:"‚îò",k:"‚îê",l:"‚îå",m:"‚îî",n:"‚îº",o:"‚é∫",p:"‚éª",q:"‚îÄ",r:"‚éº",s:"‚éΩ",t:"‚îú",u:"‚î§",v:"‚î¥",w:"‚î¨",x:"‚îÇ",y:"‚â§",z:"‚â•","{":"œÄ","|":"‚â†","}":"¬£","~":"¬∑"},Terminal.charsets.UK=null,Terminal.charsets.US=null,Terminal.charsets.Dutch=null,Terminal.charsets.Finnish=null,Terminal.charsets.French=null,Terminal.charsets.FrenchCanadian=null,Terminal.charsets.German=null,Terminal.charsets.Italian=null,Terminal.charsets.NorwegianDanish=null,Terminal.charsets.Spanish=null,Terminal.charsets.Swedish=null,Terminal.charsets.Swiss=null,Terminal.charsets.ISOLatin=null;var v=this.String,T=this.setTimeout,x=this.setInterval;h._cache={},h.distance=function(t,e,s,i,r,a){return Math.pow(30*(t-i),2)+Math.pow(59*(e-r),2)+Math.pow(11*(s-a),2)},Terminal.prototype.getText=function(t,e,s){for(var i=t+(this.lines.length-this.rows),r=this.lines[i],a="",n=e;s>n;n++)a+=r[n][1];return a},Terminal.prototype.getAllTexts=function(){for(var t=[],e=0;24>e;e++)t[e]=this.getText(e,0,80);return t},Terminal.prototype.getColor=function(t,e){var s=t+(this.lines.length-this.rows),i=this.lines[s][e][0],r=511&i,a=511&i>>9;return{frontground:a,background:r}},Terminal.EventEmitter=t,Terminal.inherits=r,Terminal.on=e,Terminal.off=s,Terminal.cancel=i,"undefined"!=typeof module?module.exports=Terminal:this.Terminal=Terminal}(),"undefined"==typeof IS_ON_IOS&&(IS_ON_IOS=!1),require("./uao"),require("./board_list"),require("./utils"),require("./logger"),require("./handlers/LoginHandler"),require("./handlers/LogoutHandler"),require("./handlers/HotHandler"),require("./handlers/FavoritesHandler"),require("./handlers/FavoritesAddHandler"),require("./handlers/FavoritesMoveHandler"),require("./handlers/FavoritesRemoveHandler"),require("./handlers/BoardHandler"),require("./handlers/ArticleHandler"),require("./handlers/CommentHandler"),require("./handlers/BoardNameFetcher"),require("./term.js"),term=new Terminal({cols:80,rows:24,screenKeys:!0});var handler=null,client,byteBuffer=[];if(IS_ON_IOS)client={write:writeMessage};else{var net=require("net"),Iconv=require("iconv").Iconv,iconv=new Iconv("BIG5","UTF-8//TRANSLIT//IGNORE");client=net.connect(23,"ptt.cc",function(){Logger.info("Client Connected")});var oldWrite=client.write;client.write=writeMessage,client.writeByteArray=function(t){oldWrite.call(client,new Buffer(t))},client.on("data",function(t){receivedFromPTT(Array.prototype.slice.call(t,0))}),client.on("end",function(){Logger.info("Client Disconnected")})}var nextHandler=null,PTT={registerSendToPTTCallback:function(t){client.writeByteArray=t},receivedFromPTT:receivedFromPTT,login:function(t,e,s){nextHandler=new LoginHandler(client,t,e,s)},logout:function(t){nextHandler=new LogoutHandler(client,t)},getHot:function(t){nextHandler=new HotHandler(client,t)},getBoard:function(t,e,s){nextHandler=new BoardHandler(client,t,e,s)},searchBoard:function(t,e,s,i){nextHandler=new BoardHandler(client,t,e,s,i)},getArticle:function(t,e,s,i){nextHandler=new ArticleHandler(client,t,e,s,i)},getSearchedArticle:function(t,e,s,i,r){nextHandler=new ArticleHandler(client,t,e,s,i,r)},postComment:function(t,e,s,i,r){nextHandler=new CommentHandler(client,t,e,s,i,r)},getFavorites:function(t,e){nextHandler=new FavoritesHandler(client,t,e)},addFavorite:function(t,e,s){nextHandler=new FavoritesAddHandler(client,t,e,s)},removeFavorite:function(t,e,s){nextHandler=new FavoritesRemoveHandler(client,t,e,s)},moveFavorite:function(t,e,s,i){nextHandler=new FavoritesMoveHandler(client,t,e,s,i)},fetchBoardNames:function(t){nextHandler=new BoardNameFetcher(client,t)}};client.setTimeout=function(t){client.timeoutStamp=Math.random();var e=client.timeoutStamp;setTimeout(function(){client.timeoutStamp===e&&(handler.isEnded()||(client.write("\r\n"),handler.callback({message:"timeout"}),handler.end(),handler=null))},t)};var mainIter=function(){if(null!==nextHandler)if(-1!==term.getAllTexts().join("").indexOf("(G)oodbye")||nextHandler instanceof LoginHandler){null===handler||handler.isEnded()||handler.callback({message:"interrupted"}),handler=nextHandler,nextHandler=null,handler.start();var t=handler.getTimeout?handler.getTimeout():5e3;client.setTimeout(t)}else client.write("q");setTimeout(mainIter,500)};mainIter(),module.exports=PTT;